<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>FGOTG ‚Äî First Goal of the Game</title>
<style>
/* ===== RESET ===== */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{font-size:16px;-webkit-text-size-adjust:100%;scroll-behavior:smooth}
button{cursor:pointer;border:none;background:none;font:inherit;color:inherit}
input,select,textarea{font:inherit}
a{color:inherit;text-decoration:none}
ul{list-style:none}

/* ===== DESIGN TOKENS ===== */
:root{
  --bg0:#070c1a;
  --bg1:#0d1528;
  --bg2:#131e36;
  --bg3:#1a2845;
  --surf:rgba(255,255,255,0.04);
  --surf2:rgba(255,255,255,0.07);
  --surf3:rgba(255,255,255,0.11);
  --bdr:rgba(255,255,255,0.07);
  --bdr2:rgba(255,255,255,0.14);
  --bdr3:rgba(255,255,255,0.22);
  --t0:#eef2ff;
  --t1:#94a3b8;
  --t2:#4a5a7a;
  --t3:#2a3550;
  --tp:#3b82f6;
  --ts:#60a5fa;
  --tglow:rgba(59,130,246,0.22);
  --ok:#22c55e;
  --err:#ef4444;
  --warn:#f59e0b;
  --gold:#fbbf24;
  --silver:#94a3b8;
  --bronze:#c97c3a;
  --nav-h:64px;
  --hdr-h:54px;
  --max-w:680px;
  --r-xs:6px;
  --r-sm:10px;
  --r-md:14px;
  --r-lg:20px;
  --r-xl:28px;
  --r-full:9999px;
}

/* ===== BASE ===== */
body{
  font-family:-apple-system,BlinkMacSystemFont,'SF Pro Display','Segoe UI',system-ui,sans-serif;
  background:var(--bg0);
  color:var(--t0);
  min-height:100vh;
  overflow-x:hidden;
  padding-bottom:var(--nav-h);
}
body::before{
  content:'';
  position:fixed;inset:0;
  background:
    radial-gradient(ellipse 80% 40% at 50% -10%,var(--tglow) 0%,transparent 100%),
    radial-gradient(ellipse 40% 30% at 90% 90%,rgba(255,255,255,0.02) 0%,transparent 100%);
  pointer-events:none;z-index:0;
  transition:background 0.6s ease;
}

/* ===== LAYOUT ===== */
#app{position:relative;z-index:1;min-height:100vh}

.page{max-width:var(--max-w);margin:0 auto;padding:0 16px 24px}
.page-full{padding:0 0 24px}

/* ===== HEADER ===== */
.hdr{
  position:sticky;top:0;z-index:100;
  height:var(--hdr-h);
  display:flex;align-items:center;gap:12px;
  padding:0 16px;
  background:rgba(7,12,26,0.85);
  backdrop-filter:blur(20px);
  -webkit-backdrop-filter:blur(20px);
  border-bottom:1px solid var(--bdr);
}
.hdr-logo{
  font-weight:800;font-size:1.2rem;letter-spacing:-0.5px;
  background:linear-gradient(135deg,var(--tp),var(--ts));
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;
  background-clip:text;
}
.hdr-league{
  flex:1;min-width:0;
  font-size:0.78rem;font-weight:600;color:var(--t1);
  overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
}
.hdr-actions{display:flex;align-items:center;gap:4px}
.hdr-btn{
  width:36px;height:36px;border-radius:var(--r-full);
  display:flex;align-items:center;justify-content:center;
  background:var(--surf);
  font-size:1.1rem;
  position:relative;
  transition:background 0.15s;
}
.hdr-btn:hover{background:var(--surf2)}
.notif-badge{
  position:absolute;top:4px;right:4px;
  width:8px;height:8px;border-radius:50%;
  background:var(--err);border:2px solid var(--bg0);
}

/* ===== BOTTOM NAV ===== */
.bottom-nav{
  position:fixed;bottom:0;left:0;right:0;z-index:100;
  height:var(--nav-h);
  display:flex;
  background:rgba(7,12,26,0.92);
  backdrop-filter:blur(20px);
  -webkit-backdrop-filter:blur(20px);
  border-top:1px solid var(--bdr);
}
.nav-item{
  flex:1;display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:3px;font-size:0.62rem;font-weight:600;letter-spacing:0.3px;
  color:var(--t2);
  transition:color 0.15s;
  padding-bottom:4px;
}
.nav-item svg{width:22px;height:22px;stroke-width:1.8}
.nav-item.active{color:var(--tp)}
.nav-item.active svg{filter:drop-shadow(0 0 6px var(--tglow))}

/* ===== CARDS ===== */
.card{
  background:var(--surf);
  border:1px solid var(--bdr);
  border-radius:var(--r-lg);
  padding:16px;
  transition:border-color 0.2s,background 0.2s;
}
.card-sm{padding:12px}
.card-glow{
  border-color:var(--tp);
  box-shadow:0 0 0 1px var(--tglow),0 4px 24px var(--tglow);
}
.card-clickable:hover{background:var(--surf2);border-color:var(--bdr2)}
.card-clickable:active{transform:scale(0.99)}

/* ===== SECTION LABELS ===== */
.section-label{
  font-size:0.68rem;font-weight:700;letter-spacing:1.2px;
  text-transform:uppercase;color:var(--t2);
  margin:20px 0 10px;
}

/* ===== TYPOGRAPHY ===== */
.text-xl{font-size:1.5rem;font-weight:800;letter-spacing:-0.5px}
.text-lg{font-size:1.1rem;font-weight:700}
.text-md{font-size:0.9rem;font-weight:600}
.text-sm{font-size:0.82rem;font-weight:500}
.text-xs{font-size:0.72rem}
.text-muted{color:var(--t1)}
.text-dim{color:var(--t2)}
.text-ok{color:var(--ok)}
.text-err{color:var(--err)}
.text-warn{color:var(--warn)}
.text-gold{color:var(--gold)}
.text-team{color:var(--tp)}
.fw-bold{font-weight:700}
.fw-black{font-weight:900}

/* ===== BUTTONS ===== */
.btn{
  display:inline-flex;align-items:center;justify-content:center;gap:8px;
  padding:0 20px;height:44px;
  border-radius:var(--r-full);
  font-size:0.88rem;font-weight:700;letter-spacing:0.2px;
  transition:all 0.15s;
  white-space:nowrap;
}
.btn:active{transform:scale(0.97)}
.btn-primary{background:var(--tp);color:#fff;box-shadow:0 4px 16px var(--tglow)}
.btn-primary:hover{filter:brightness(1.1)}
.btn-secondary{background:var(--surf2);border:1px solid var(--bdr2);color:var(--t0)}
.btn-secondary:hover{background:var(--surf3)}
.btn-ghost{background:transparent;color:var(--t1)}
.btn-ghost:hover{background:var(--surf);color:var(--t0)}
.btn-danger{background:var(--err);color:#fff}
.btn-success{background:var(--ok);color:#fff}
.btn-sm{height:34px;padding:0 14px;font-size:0.8rem}
.btn-lg{height:52px;padding:0 28px;font-size:0.95rem}
.btn-block{width:100%}
.btn:disabled{opacity:0.4;cursor:not-allowed;transform:none}

/* ===== FORMS ===== */
.form-group{margin-bottom:16px}
.form-label{
  display:block;font-size:0.78rem;font-weight:600;color:var(--t1);
  margin-bottom:6px;letter-spacing:0.3px;
}
.form-input{
  width:100%;height:46px;
  background:var(--surf);
  border:1px solid var(--bdr2);
  border-radius:var(--r-sm);
  padding:0 14px;
  color:var(--t0);font-size:0.9rem;
  transition:border-color 0.15s,box-shadow 0.15s;
  -webkit-appearance:none;
}
.form-input:focus{
  outline:none;
  border-color:var(--tp);
  box-shadow:0 0 0 3px var(--tglow);
}
.form-input::placeholder{color:var(--t2)}
.form-select{background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke='%234a5a7a'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' stroke-width='2' d='M19 9l-7 7-7-7'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;background-size:16px;padding-right:40px;cursor:pointer}
.form-hint{font-size:0.72rem;color:var(--t2);margin-top:5px}
.form-error{font-size:0.72rem;color:var(--err);margin-top:5px}

/* ===== TOGGLE GROUP ===== */
.toggle-group{display:flex;background:var(--surf);border:1px solid var(--bdr2);border-radius:var(--r-sm);padding:3px;gap:2px}
.toggle-item{
  flex:1;height:38px;border-radius:var(--r-xs);
  font-size:0.82rem;font-weight:600;color:var(--t1);
  transition:all 0.15s;
}
.toggle-item.active{background:var(--tp);color:#fff;box-shadow:0 2px 8px var(--tglow)}

/* ===== PILLS ===== */
.pill{
  display:inline-flex;align-items:center;gap:4px;
  padding:3px 10px;border-radius:var(--r-full);
  font-size:0.7rem;font-weight:700;letter-spacing:0.5px;text-transform:uppercase;
}
.pill-ok{background:rgba(34,197,94,0.15);color:var(--ok);border:1px solid rgba(34,197,94,0.25)}
.pill-err{background:rgba(239,68,68,0.15);color:var(--err);border:1px solid rgba(239,68,68,0.25)}
.pill-warn{background:rgba(245,158,11,0.15);color:var(--warn);border:1px solid rgba(245,158,11,0.25)}
.pill-blue{background:rgba(59,130,246,0.15);color:var(--tp);border:1px solid rgba(59,130,246,0.25)}
.pill-gray{background:var(--surf2);color:var(--t1);border:1px solid var(--bdr2)}
.pill-gold{background:rgba(251,191,36,0.15);color:var(--gold);border:1px solid rgba(251,191,36,0.25)}

/* ===== SCORE BADGE ===== */
.score-badge{
  display:inline-flex;align-items:baseline;gap:3px;
  font-weight:900;font-size:2rem;color:var(--tp);
  line-height:1;
}
.score-badge span{font-size:0.9rem;font-weight:600;color:var(--t1)}

/* ===== AVATAR ===== */
.avatar{
  width:40px;height:40px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  background:linear-gradient(135deg,var(--tp),var(--ts));
  font-weight:800;font-size:1rem;color:#fff;
  flex-shrink:0;
}
.avatar-sm{width:32px;height:32px;font-size:0.8rem}
.avatar-lg{width:52px;height:52px;font-size:1.3rem}

/* ===== DIVIDER ===== */
.divider{height:1px;background:var(--bdr);margin:16px 0}
.divider-label{
  display:flex;align-items:center;gap:12px;color:var(--t2);
  font-size:0.72rem;font-weight:600;letter-spacing:0.5px;margin:16px 0;
}
.divider-label::before,.divider-label::after{content:'';flex:1;height:1px;background:var(--bdr)}

/* ===== STAT ROW ===== */
.stat-row{display:flex;align-items:center;gap:12px;padding:10px 0;border-bottom:1px solid var(--bdr)}
.stat-row:last-child{border-bottom:none}
.stat-rank{width:28px;text-align:center;font-weight:800;font-size:1rem;color:var(--t2)}
.stat-rank.gold{color:var(--gold)}
.stat-rank.silver{color:var(--silver)}
.stat-rank.bronze{color:var(--bronze)}
.stat-info{flex:1;min-width:0}
.stat-name{font-weight:600;font-size:0.9rem;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.stat-sub{font-size:0.72rem;color:var(--t2)}
.stat-pts{font-weight:800;font-size:1.1rem;color:var(--tp)}

/* ===== GAME CARD ===== */
.game-card{
  background:var(--surf);border:1px solid var(--bdr);
  border-radius:var(--r-lg);overflow:hidden;
  margin-bottom:12px;
}
.game-card-header{
  padding:12px 16px;
  background:var(--surf2);
  display:flex;align-items:center;justify-content:space-between;
  border-bottom:1px solid var(--bdr);
}
.game-card-body{padding:14px 16px}
.game-vs{font-weight:800;font-size:1rem}
.game-time{font-size:0.78rem;color:var(--t1)}
.game-countdown{
  font-size:0.72rem;font-weight:700;letter-spacing:0.5px;
  color:var(--warn);
}

/* ===== PICK DISPLAY ===== */
.pick-slot{
  display:flex;align-items:center;gap:12px;
  padding:10px 12px;border-radius:var(--r-sm);
  background:var(--surf2);margin-bottom:8px;
}
.pick-slot-icon{
  width:32px;height:32px;border-radius:50%;
  display:flex;align-items:center;justify-content:center;
  font-size:0.9rem;flex-shrink:0;
}
.pick-slot-label{font-size:0.68rem;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--t2)}
.pick-slot-value{font-size:0.9rem;font-weight:600}
.pick-slot.correct{background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.2)}
.pick-slot.wrong{background:rgba(239,68,68,0.06);border:1px solid rgba(239,68,68,0.15)}

/* ===== PLAYER SEARCH ===== */
.player-search-wrap{position:relative}
.player-dropdown{
  position:absolute;top:100%;left:0;right:0;z-index:50;
  background:var(--bg2);border:1px solid var(--bdr2);
  border-radius:var(--r-sm);margin-top:4px;
  max-height:200px;overflow-y:auto;
  box-shadow:0 8px 32px rgba(0,0,0,0.4);
}
.player-option{
  padding:10px 14px;font-size:0.88rem;cursor:pointer;
  display:flex;align-items:center;justify-content:space-between;
  transition:background 0.1s;
}
.player-option:hover{background:var(--surf2)}
.player-option .ineligible-tag{font-size:0.65rem;color:var(--warn)}

/* ===== MODAL ===== */
.modal-overlay{
  position:fixed;inset:0;z-index:200;
  background:rgba(0,0,0,0.7);backdrop-filter:blur(4px);
  display:flex;align-items:flex-end;justify-content:center;
  opacity:0;pointer-events:none;transition:opacity 0.2s;
}
.modal-overlay.open{opacity:1;pointer-events:all}
.modal-sheet{
  background:var(--bg1);border-radius:var(--r-xl) var(--r-xl) 0 0;
  width:100%;max-width:var(--max-w);
  border-top:1px solid var(--bdr2);
  max-height:90vh;overflow-y:auto;
  padding:20px 20px 40px;
  transform:translateY(100%);transition:transform 0.3s cubic-bezier(0.32,0.72,0,1);
}
.modal-overlay.open .modal-sheet{transform:translateY(0)}
.modal-handle{
  width:36px;height:4px;border-radius:2px;
  background:var(--bdr3);margin:0 auto 20px;
}
.modal-title{font-size:1.1rem;font-weight:800;margin-bottom:16px}

/* ===== TOAST ===== */
#toast-container{
  position:fixed;bottom:calc(var(--nav-h) + 12px);left:50%;
  transform:translateX(-50%);
  z-index:300;display:flex;flex-direction:column;gap:8px;
  align-items:center;pointer-events:none;
  width:calc(100% - 32px);max-width:400px;
}
.toast{
  padding:12px 18px;border-radius:var(--r-md);
  font-size:0.85rem;font-weight:600;
  box-shadow:0 4px 24px rgba(0,0,0,0.4);
  animation:toast-in 0.3s ease forwards;
  pointer-events:all;
  max-width:100%;text-align:center;
}
.toast-ok{background:#166534;border:1px solid var(--ok);color:#bbf7d0}
.toast-err{background:#7f1d1d;border:1px solid var(--err);color:#fecaca}
.toast-info{background:var(--bg2);border:1px solid var(--bdr2);color:var(--t0)}
@keyframes toast-in{from{opacity:0;transform:translateY(12px)}to{opacity:1;transform:translateY(0)}}

/* ===== EMPTY STATE ===== */
.empty{
  text-align:center;padding:48px 24px;
  display:flex;flex-direction:column;align-items:center;gap:12px;
}
.empty-icon{font-size:3rem;opacity:0.4}
.empty-title{font-weight:700;font-size:1rem}
.empty-sub{font-size:0.84rem;color:var(--t1);max-width:280px}

/* ===== NOTIFICATION ITEM ===== */
.notif-item{
  display:flex;gap:12px;align-items:flex-start;
  padding:12px 0;border-bottom:1px solid var(--bdr);
}
.notif-dot{
  width:8px;height:8px;border-radius:50%;
  background:var(--tp);flex-shrink:0;margin-top:5px;
}
.notif-dot.read{background:var(--t3)}
.notif-msg{font-size:0.85rem;line-height:1.4}
.notif-time{font-size:0.7rem;color:var(--t2);margin-top:3px}

/* ===== AUTH PAGE ===== */
.auth-hero{
  text-align:center;padding:48px 24px 32px;
}
.auth-logo{
  font-size:2.8rem;font-weight:900;letter-spacing:-1px;
  background:linear-gradient(135deg,var(--tp) 0%,var(--ts) 50%,#a78bfa 100%);
  -webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;
}
.auth-tagline{font-size:0.9rem;color:var(--t1);margin-top:6px}

/* ===== TEAM GRID ===== */
.team-grid{
  display:grid;grid-template-columns:repeat(4,1fr);gap:8px;
  padding:16px 0;
}
.team-tile{
  display:flex;flex-direction:column;align-items:center;gap:4px;
  padding:12px 6px;border-radius:var(--r-md);
  border:2px solid transparent;
  background:var(--surf);
  cursor:pointer;transition:all 0.15s;
  -webkit-tap-highlight-color:transparent;
}
.team-tile:hover{background:var(--surf2)}
.team-tile.selected{border-color:var(--tp);background:var(--surf2);box-shadow:0 0 0 1px var(--tglow)}
.team-emoji{font-size:1.5rem}
.team-abbr{font-size:0.65rem;font-weight:800;letter-spacing:0.5px}

/* ===== COUNTDOWN ===== */
.countdown-wrap{
  display:flex;gap:8px;justify-content:center;padding:12px 0;
}
.countdown-block{
  text-align:center;
  background:var(--surf2);border-radius:var(--r-sm);
  padding:8px 12px;min-width:52px;
}
.countdown-num{font-size:1.4rem;font-weight:900;line-height:1}
.countdown-lbl{font-size:0.58rem;font-weight:700;text-transform:uppercase;letter-spacing:0.5px;color:var(--t2);margin-top:2px}

/* ===== SCORE BREAKDOWN ===== */
.breakdown-row{
  display:flex;align-items:center;justify-content:space-between;
  padding:6px 0;border-bottom:1px solid var(--bdr);
  font-size:0.83rem;
}
.breakdown-row:last-child{border-bottom:none}
.breakdown-pts{font-weight:800;color:var(--ok)}
.breakdown-pts.zero{color:var(--t2)}

/* ===== ADMIN ===== */
.admin-tabs{
  display:flex;gap:2px;background:var(--surf);
  border-radius:var(--r-sm);padding:3px;margin-bottom:16px;
}
.admin-tab{
  flex:1;height:34px;border-radius:var(--r-xs);
  font-size:0.75rem;font-weight:700;color:var(--t1);
  transition:all 0.15s;
}
.admin-tab.active{background:var(--tp);color:#fff}

.admin-action-row{
  display:flex;align-items:center;justify-content:space-between;
  gap:12px;padding:12px 0;border-bottom:1px solid var(--bdr);
}
.admin-action-row:last-child{border-bottom:none}

/* ===== LEADERBOARD PODIUM ===== */
.podium{
  display:flex;align-items:flex-end;justify-content:center;
  gap:8px;padding:16px 0 24px;
}
.podium-item{
  display:flex;flex-direction:column;align-items:center;gap:6px;
  flex:1;
}
.podium-block{
  width:100%;border-radius:var(--r-sm) var(--r-sm) 0 0;
  display:flex;flex-direction:column;align-items:center;
  justify-content:flex-end;padding:8px 4px;
  font-weight:800;font-size:1.1rem;
}
.podium-1 .podium-block{background:linear-gradient(180deg,rgba(251,191,36,0.25),rgba(251,191,36,0.1));border:1px solid rgba(251,191,36,0.3);height:90px;color:var(--gold)}
.podium-2 .podium-block{background:linear-gradient(180deg,rgba(148,163,184,0.2),rgba(148,163,184,0.08));border:1px solid rgba(148,163,184,0.25);height:68px;color:var(--silver)}
.podium-3 .podium-block{background:linear-gradient(180deg,rgba(201,124,58,0.2),rgba(201,124,58,0.08));border:1px solid rgba(201,124,58,0.25);height:52px;color:var(--bronze)}
.podium-name{font-size:0.7rem;font-weight:600;color:var(--t1);text-align:center;max-width:64px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}

/* ===== ANIMATIONS ===== */
@keyframes slide-up{from{opacity:0;transform:translateY(16px)}to{opacity:1;transform:translateY(0)}}
@keyframes fade-in{from{opacity:0}to{opacity:1}}
@keyframes pulse-glow{0%,100%{box-shadow:0 0 0 0 var(--tglow)}50%{box-shadow:0 0 0 8px transparent}}
.anim-slide-up{animation:slide-up 0.35s ease both}
.anim-fade{animation:fade-in 0.25s ease both}

/* ===== UTILS ===== */
.flex{display:flex}.flex-col{flex-direction:column}
.items-center{align-items:center}.justify-between{justify-content:space-between}
.gap-4{gap:4px}.gap-8{gap:8px}.gap-12{gap:12px}.gap-16{gap:16px}
.w-full{width:100%}.h-full{height:100%}
.mt-4{margin-top:4px}.mt-8{margin-top:8px}.mt-12{margin-top:12px}.mt-16{margin-top:16px}.mt-24{margin-top:24px}
.mb-4{margin-bottom:4px}.mb-8{margin-bottom:8px}.mb-12{margin-bottom:12px}.mb-16{margin-bottom:16px}
.p-0{padding:0}.truncate{overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.hidden{display:none!important}
.sr-only{position:absolute;width:1px;height:1px;overflow:hidden;clip:rect(0,0,0,0)}
.text-center{text-align:center}.text-right{text-align:right}

/* ===== SCROLLBAR ===== */
::-webkit-scrollbar{width:4px;height:4px}
::-webkit-scrollbar-track{background:transparent}
::-webkit-scrollbar-thumb{background:var(--bdr2);border-radius:2px}

/* ===== SWITCH ===== */
.switch-wrap{display:flex;align-items:center;gap:12px;cursor:pointer}
.switch{
  width:44px;height:24px;border-radius:12px;
  background:var(--surf3);border:1px solid var(--bdr2);
  position:relative;transition:background 0.2s;flex-shrink:0;
}
.switch.on{background:var(--tp)}
.switch::after{
  content:'';position:absolute;top:2px;left:2px;
  width:18px;height:18px;border-radius:50%;background:#fff;
  transition:transform 0.2s;box-shadow:0 1px 4px rgba(0,0,0,0.3);
}
.switch.on::after{transform:translateX(20px)}

/* ===== SEASON BANNER ===== */
.season-banner{
  background:linear-gradient(135deg,var(--surf2),var(--surf));
  border:1px solid var(--bdr2);
  border-radius:var(--r-lg);
  padding:16px;
  margin-bottom:16px;
  position:relative;overflow:hidden;
}
.season-banner::before{
  content:'üèí';
  position:absolute;right:-8px;bottom:-8px;
  font-size:4rem;opacity:0.08;
}

/* ===== TABS ===== */
.tabs{display:flex;border-bottom:1px solid var(--bdr);margin-bottom:16px}
.tab{
  padding:10px 16px;font-size:0.84rem;font-weight:600;color:var(--t2);
  border-bottom:2px solid transparent;transition:all 0.15s;
}
.tab.active{color:var(--tp);border-bottom-color:var(--tp)}

/* ===== RESULT DISPLAY ===== */
.result-banner{
  border-radius:var(--r-md);padding:14px 16px;margin-bottom:12px;
  display:flex;align-items:center;gap:12px;
}
.result-banner.shutout{background:rgba(59,130,246,0.1);border:1px solid rgba(59,130,246,0.25)}
.result-banner.goal{background:rgba(34,197,94,0.08);border:1px solid rgba(34,197,94,0.2)}
.result-icon{font-size:1.8rem}

/* ===== DARK HORSE TOGGLE ===== */
.dh-toggle{
  display:flex;border-radius:var(--r-sm);overflow:hidden;
  border:1px solid var(--bdr2);margin-bottom:12px;
}
.dh-toggle-opt{
  flex:1;padding:10px;text-align:center;
  font-size:0.82rem;font-weight:700;color:var(--t1);
  transition:all 0.15s;cursor:pointer;
}
.dh-toggle-opt.active{
  background:linear-gradient(135deg,var(--tp),var(--ts));
  color:#fff;
}
.dh-toggle-opt.active-shutout{
  background:linear-gradient(135deg,#6366f1,#8b5cf6);
  color:#fff;
}

/* ===== INELIGIBLE TAG ===== */
.inelig-badge{
  font-size:0.65rem;font-weight:700;text-transform:uppercase;letter-spacing:0.3px;
  background:rgba(245,158,11,0.15);color:var(--warn);
  border:1px solid rgba(245,158,11,0.25);border-radius:var(--r-full);
  padding:2px 7px;
}

/* ===== HISTORY ITEM ===== */
.history-item{
  border-radius:var(--r-md);border:1px solid var(--bdr);
  overflow:hidden;margin-bottom:10px;
}
.history-header{
  padding:10px 14px;background:var(--surf2);
  display:flex;align-items:center;justify-content:space-between;
}
.history-body{padding:12px 14px}

/* ===== PAGE TRANSITION ===== */
.page-enter{animation:slide-up 0.3s ease both}

/* ===== RESPONSIVE ===== */
@media(min-width:640px){
  body{padding-bottom:0;padding-left:220px}
  .bottom-nav{display:none}
  .sidebar{
    position:fixed;left:0;top:0;bottom:0;width:220px;
    background:rgba(7,12,26,0.95);
    backdrop-filter:blur(20px);
    border-right:1px solid var(--bdr);
    display:flex!important;flex-direction:column;gap:4px;
    padding:20px 12px;z-index:100;
  }
  .sidebar-logo{
    font-size:1.3rem;font-weight:900;letter-spacing:-0.5px;
    background:linear-gradient(135deg,var(--tp),var(--ts));
    -webkit-background-clip:text;-webkit-text-fill-color:transparent;
    background-clip:text;padding:8px 10px 20px;
  }
  .sidebar-item{
    display:flex!important;align-items:center;gap:10px;
    padding:10px 12px;border-radius:var(--r-sm);
    font-size:0.88rem;font-weight:600;color:var(--t1);
    transition:all 0.15s;cursor:pointer;
  }
  .sidebar-item:hover{background:var(--surf2);color:var(--t0)}
  .sidebar-item.active{background:rgba(59,130,246,0.15);color:var(--tp)}
  .sidebar-item svg{width:18px;height:18px;stroke-width:1.8;flex-shrink:0}
  .hdr{padding-left:236px}
  .team-grid{grid-template-columns:repeat(6,1fr)}
}
</style>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
<div id="sidebar" class="sidebar hidden"></div>
<div id="app"></div>
<div id="modal-overlay" class="modal-overlay">
  <div class="modal-sheet" id="modal-sheet">
    <div class="modal-handle"></div>
    <div id="modal-content"></div>
  </div>
</div>
<div id="toast-container"></div>

<script>
'use strict';
// ============================================================
// FGOTG ‚Äî First Goal of the Game
// Single-file app ¬∑ Supabase backend ¬∑ ¬© 2025
// ============================================================

window.onerror = function(msg, src, line, col, err) {
  const app = document.getElementById('app');
  if (app) app.innerHTML = `<div style="color:#f87171;padding:24px;font-family:monospace;line-height:1.6"><b>JS Error:</b> ${msg}<br>Line ${line} ‚Äî ${src}<br><pre style="margin-top:8px;white-space:pre-wrap">${err?.stack||''}</pre></div>`;
};
window.onunhandledrejection = function(e) {
  const app = document.getElementById('app');
  if (app) app.innerHTML = `<div style="color:#f87171;padding:24px;font-family:monospace"><b>Unhandled rejection:</b> ${e.reason?.message||e.reason}</div>`;
};

// =================== SUPABASE CONFIG ========================
// Fill in from: Supabase Dashboard ‚Üí Project Settings ‚Üí API
const SUPABASE_URL      = 'https://gsectdeyspqwlrkrdzrm.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImdzZWN0ZGV5c3Bxd2xya3JkenJtIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzIxODY2MTQsImV4cCI6MjA4Nzc2MjYxNH0.EpG7c-p98MfYSOO0gGL2EBUWbWzTVTdIER3s02xQiS8';
if (!window.supabase) throw new Error('Supabase CDN failed to load ‚Äî check your internet connection.');
const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

// ===================== CONVERTERS ===========================
function toSnake(obj) {
  if (obj === null || obj === undefined || typeof obj !== 'object') return obj;
  if (Array.isArray(obj)) return obj.map(toSnake);
  return Object.fromEntries(
    Object.entries(obj).map(([k, v]) => [k.replace(/[A-Z]/g, c => '_' + c.toLowerCase()), toSnake(v)])
  );
}
function toCamel(obj) {
  if (obj === null || obj === undefined || typeof obj !== 'object') return obj;
  if (Array.isArray(obj)) return obj.map(toCamel);
  return Object.fromEntries(
    Object.entries(obj).map(([k, v]) => [k.replace(/_([a-z])/g, (_, c) => c.toUpperCase()), toCamel(v)])
  );
}

// ===================== NHL TEAMS ============================
const TEAMS = {
  ANA:{name:'Anaheim Ducks',city:'Anaheim',abbr:'ANA',p:'#F47A38',s:'#B9975B',e:'ü¶Ü'},
  BOS:{name:'Boston Bruins',city:'Boston',abbr:'BOS',p:'#FFB81C',s:'#000000',e:'üêª'},
  BUF:{name:'Buffalo Sabres',city:'Buffalo',abbr:'BUF',p:'#002654',s:'#FCB514',e:'‚öîÔ∏è'},
  CGY:{name:'Calgary Flames',city:'Calgary',abbr:'CGY',p:'#C8102E',s:'#F1BE48',e:'üî•'},
  CAR:{name:'Carolina Hurricanes',city:'Carolina',abbr:'CAR',p:'#CC0000',s:'#000000',e:'üåÄ'},
  CHI:{name:'Chicago Blackhawks',city:'Chicago',abbr:'CHI',p:'#CF0A2C',s:'#FF671B',e:'ü™∂'},
  COL:{name:'Colorado Avalanche',city:'Colorado',abbr:'COL',p:'#6F263D',s:'#236192',e:'‚õ∞Ô∏è'},
  CBJ:{name:'Columbus Blue Jackets',city:'Columbus',abbr:'CBJ',p:'#002654',s:'#CE1126',e:'üöÄ'},
  DAL:{name:'Dallas Stars',city:'Dallas',abbr:'DAL',p:'#006847',s:'#8F8F8C',e:'‚≠ê'},
  DET:{name:'Detroit Red Wings',city:'Detroit',abbr:'DET',p:'#CE1126',s:'#FFFFFF',e:'üî¥'},
  EDM:{name:'Edmonton Oilers',city:'Edmonton',abbr:'EDM',p:'#FF4C00',s:'#003777',e:'üõ¢Ô∏è'},
  FLA:{name:'Florida Panthers',city:'Florida',abbr:'FLA',p:'#041E42',s:'#C8102E',e:'üêÜ'},
  LAK:{name:'Los Angeles Kings',city:'Los Angeles',abbr:'LAK',p:'#111111',s:'#A2AAAD',e:'üëë'},
  MIN:{name:'Minnesota Wild',city:'Minnesota',abbr:'MIN',p:'#154734',s:'#A6192E',e:'üå≤'},
  MTL:{name:'Montr√©al Canadiens',city:'Montr√©al',abbr:'MTL',p:'#AF1E2D',s:'#192168',e:'üîµ'},
  NSH:{name:'Nashville Predators',city:'Nashville',abbr:'NSH',p:'#FFB81C',s:'#041E42',e:'üé∏'},
  NJD:{name:'New Jersey Devils',city:'New Jersey',abbr:'NJD',p:'#CE1126',s:'#000000',e:'üòà'},
  NYI:{name:'New York Islanders',city:'New York',abbr:'NYI',p:'#00539B',s:'#F47D30',e:'üóΩ'},
  NYR:{name:'New York Rangers',city:'New York',abbr:'NYR',p:'#0038A8',s:'#CE1126',e:'üóΩ'},
  OTT:{name:'Ottawa Senators',city:'Ottawa',abbr:'OTT',p:'#C2912C',s:'#000000',e:'üèõÔ∏è'},
  PHI:{name:'Philadelphia Flyers',city:'Philadelphia',abbr:'PHI',p:'#F74902',s:'#000000',e:'üü†'},
  PIT:{name:'Pittsburgh Penguins',city:'Pittsburgh',abbr:'PIT',p:'#FCB514',s:'#000000',e:'üêß'},
  SJS:{name:'San Jose Sharks',city:'San Jose',abbr:'SJS',p:'#006D75',s:'#EA7200',e:'ü¶à'},
  SEA:{name:'Seattle Kraken',city:'Seattle',abbr:'SEA',p:'#001628',s:'#99D9D9',e:'üêô'},
  STL:{name:'St. Louis Blues',city:'St. Louis',abbr:'STL',p:'#002F87',s:'#FCB514',e:'üéµ'},
  TBL:{name:'Tampa Bay Lightning',city:'Tampa Bay',abbr:'TBL',p:'#002868',s:'#FFFFFF',e:'‚ö°'},
  TOR:{name:'Toronto Maple Leafs',city:'Toronto',abbr:'TOR',p:'#00205B',s:'#FFFFFF',e:'üçÅ'},
  UTA:{name:'Utah Hockey Club',city:'Utah',abbr:'UTA',p:'#69B3E7',s:'#010101',e:'üèîÔ∏è'},
  VAN:{name:'Vancouver Canucks',city:'Vancouver',abbr:'VAN',p:'#00205B',s:'#009639',e:'üçÅ'},
  VGK:{name:'Vegas Golden Knights',city:'Vegas',abbr:'VGK',p:'#B4975A',s:'#333F42',e:'‚öîÔ∏è'},
  WSH:{name:'Washington Capitals',city:'Washington',abbr:'WSH',p:'#041E42',s:'#C8102E',e:'ü¶Ö'},
  WPG:{name:'Winnipeg Jets',city:'Winnipeg',abbr:'WPG',p:'#041E42',s:'#004C97',e:'‚úàÔ∏è'},
};

const TEAMS_SORTED = Object.keys(TEAMS).sort((a,b)=>TEAMS[a].city.localeCompare(TEAMS[b].city));

// ===================== ROSTERS ==============================
const BASE_ROSTERS = {
  ANA:['Trevor Zegras','Mason McTavish','Troy Terry','Adam Henrique','Frank Vatrano','Cam Fowler','Lukas Dostal'],
  BOS:['David Pastrnak','Brad Marchand','Pavel Zacha','Charlie Coyle','Charlie McAvoy','Hampus Lindholm','Jeremy Swayman'],
  BUF:['Tage Thompson','Alex Tuch','JJ Peterka','Dylan Cozens','Rasmus Dahlin','Owen Power','Ukko-Pekka Luukkonen'],
  CGY:['Nazem Kadri','Jonathan Huberdeau','Mikael Backlund','Tyler Toffoli','Rasmus Andersson','MacKenzie Weegar','Dan Vladar'],
  CAR:['Sebastian Aho','Andrei Svechnikov','Seth Jarvis','Jordan Staal','Jesperi Kotkaniemi','Jaccob Slavin','Frederik Andersen'],
  CHI:['Connor Bedard','Taylor Hall','Nick Foligno','Seth Jones','Alex Vlasic','Petr Mrazek','Philipp Kurashev'],
  COL:['Nathan MacKinnon','Mikko Rantanen','Valeri Nichushkin','Gabriel Landeskog','Cale Makar','Devon Toews','Alexandar Georgiev'],
  CBJ:['Boone Jenner','Sean Monahan','Zach Werenski','David Jiricek','Elvis Merzlikins','Kirill Marchenko','Cole Sillinger'],
  DAL:['Jason Robertson','Roope Hintz','Joe Pavelski','Tyler Seguin','Wyatt Johnston','Miro Heiskanen','Jake Oettinger'],
  DET:['Dylan Larkin','Lucas Raymond','David Perron','Moritz Seider','Ben Chiarot','Alex Lyon','Patrick Kane'],
  EDM:['Connor McDavid','Leon Draisaitl','Zach Hyman','Ryan Nugent-Hopkins','Evander Kane','Darnell Nurse','Stuart Skinner'],
  FLA:['Aleksander Barkov','Matthew Tkachuk','Sam Reinhart','Carter Verhaeghe','Anton Lundell','Gustav Forsling','Sergei Bobrovsky'],
  LAK:['Anze Kopitar','Kevin Fiala','Adrian Kempe','Trevor Moore','Phillip Danault','Drew Doughty','David Rittich'],
  MIN:['Kirill Kaprizov','Matt Boldy','Mats Zuccarello','Joel Eriksson Ek','Marco Rossi','Jared Spurgeon','Marc-Andre Fleury'],
  MTL:['Nick Suzuki','Juraj Slafkovsky','Cole Caufield','Kirby Dach','Josh Anderson','Kaiden Guhle','Sam Montembeault'],
  NSH:['Roman Josi','Filip Forsberg','Ryan O\'Reilly','Jonathan Marchessault','Tommy Novak','Juuse Saros','Dante Fabbro'],
  NJD:['Nico Hischier','Jack Hughes','Jesper Bratt','Timo Meier','Dougie Hamilton','Damon Severson','Vitek Vanecek'],
  NYI:['Mathew Barzal','Bo Horvat','Kyle Palmieri','Anders Lee','Noah Dobson','Ryan Pulock','Ilya Sorokin','Matthew Schaefer','Simon Holmstrom','Hudson Fasching','Pierre Engvall','Maxim Tsyplakov','Cal Clutterbuck'],
  NYR:['Artemi Panarin','Chris Kreider','Mika Zibanejad','Vincent Trocheck','Adam Fox','K\'Andre Miller','Igor Shesterkin'],
  OTT:['Tim Stutzle','Brady Tkachuk','Claude Giroux','Josh Norris','Jake Sanderson','Thomas Chabot','Cam Talbot'],
  PHI:['Sean Couturier','Travis Konecny','Joel Farabee','Travis Sanheim','Ivan Provorov','Carter Hart','Owen Tippett'],
  PIT:['Sidney Crosby','Evgeni Malkin','Bryan Rust','Rickard Rakell','Kris Letang','Jeff Petry','Tristan Jarry'],
  SJS:['Logan Couture','Tomas Hertl','Kevin Labanc','Nico Sturm','Mario Ferraro','Mackenzie Blackwood','William Eklund'],
  SEA:['Matty Beniers','Jordan Eberle','Jared McCann','Shane Wright','Vince Dunn','Shea Theodore','Philipp Grubauer'],
  STL:['Brayden Schenn','Jordan Kyrou','Pavel Buchnevich','Torey Krug','Justin Faulk','Jordan Binnington','Robert Thomas'],
  TBL:['Steven Stamkos','Nikita Kucherov','Brayden Point','Anthony Cirelli','Nick Paul','Victor Hedman','Andrei Vasilevskiy'],
  TOR:['Auston Matthews','Mitch Marner','William Nylander','John Tavares','Morgan Rielly','T.J. Brodie','Ilya Samsonov'],
  UTA:['Clayton Keller','Nick Schmaltz','Lawson Crouse','Dylan Guenther','Barrett Hayton','Mikhail Sergachev','Karel Vejmelka'],
  VAN:['Elias Pettersson','J.T. Miller','Brock Boeser','Conor Garland','Quinn Hughes','Oliver Ekman-Larsson','Thatcher Demko'],
  VGK:['Jack Eichel','Mark Stone','William Karlsson','Chandler Stephenson','Alex Pietrangelo','Shea Theodore','Adin Hill'],
  WSH:['Alex Ovechkin','Evgeny Kuznetsov','Tom Wilson','Lars Eller','John Carlson','Dmitry Orlov','Darcy Kuemper'],
  WPG:['Mark Scheifele','Kyle Connor','Nikolaj Ehlers','Josh Morrissey','Dylan DeMelo','Connor Hellebuyck','Gabriel Vilardi'],
};

// ===================== STATE ================================
const S = {
  user: null,        // camelCase profile {id, username, teamId, email, ‚Ä¶}
  authUser: null,    // raw Supabase auth user
  league: null,      // current league object (camelCase) + myRole
  userLeagues: [],   // all leagues user belongs to
  view: 'auth',
  params: {},
  isAdmin: false,    // cached flag for current league
  unread: 0,         // cached unread notification count
  channels: [],      // active realtime channel handles
  timers: [],        // active countdown interval IDs
};

// ===================== DB LAYER =============================
const DB = {
  // --- Profiles ---
  async getProfile(id) {
    const {data} = await sb.from('profiles').select('*').eq('id', id).single();
    return data ? toCamel(data) : null;
  },
  async updateProfile(id, patch) {
    const {error} = await sb.from('profiles').update(toSnake(patch)).eq('id', id);
    if (!error && S.user?.id === id) S.user = {...S.user, ...patch};
    return !error;
  },

  // --- Leagues ---
  async getUserLeagues(userId) {
    const {data} = await sb.from('league_members').select('role, leagues(*)').eq('user_id', userId);
    return (data||[]).map(m => ({...toCamel(m.leagues), myRole: m.role}));
  },
  async getLeague(id) {
    const {data} = await sb.from('leagues').select('*').eq('id', id).single();
    return data ? toCamel(data) : null;
  },
  async getAllLeaguesForTeam(teamId) {
    const {data} = await sb.from('leagues').select('*, league_members(count)').eq('team_id', teamId);
    return (data||[]).map(l => ({...toCamel(l), memberCount: l.league_members?.[0]?.count || 0}));
  },
  async createLeague(data) {
    const {data: l, error} = await sb.from('leagues').insert(toSnake(data)).select().single();
    if (error) throw error;
    return toCamel(l);
  },
  async updateLeague(id, patch) {
    const {error} = await sb.from('leagues').update(toSnake(patch)).eq('id', id);
    if (!error && S.league?.id === id) S.league = {...S.league, ...patch};
    return !error;
  },

  // --- League Members ---
  async addMember(leagueId, userId, role='member') {
    const {error} = await sb.from('league_members').insert({league_id: leagueId, user_id: userId, role});
    return !error;
  },
  async getLeagueMembers(leagueId) {
    const {data} = await sb.from('league_members')
      .select('user_id, role, profiles(username, email)')
      .eq('league_id', leagueId);
    return (data||[]).map(m => ({userId: m.user_id, role: m.role, username: m.profiles?.username||'?', email: m.profiles?.email||''}));
  },
  async setMemberRole(leagueId, userId, role) {
    const {error} = await sb.from('league_members').update({role}).eq('league_id', leagueId).eq('user_id', userId);
    return !error;
  },
  async removeMember(leagueId, userId) {
    const {error} = await sb.from('league_members').delete().eq('league_id', leagueId).eq('user_id', userId);
    return !error;
  },

  // --- Seasons ---
  async getLeagueSeasons(leagueId) {
    const {data} = await sb.from('seasons').select('*').eq('league_id', leagueId).order('created_at');
    return (data||[]).map(toCamel);
  },
  async activeSeason(leagueId) {
    const {data} = await sb.from('seasons').select('*').eq('league_id', leagueId).eq('status', 'active').maybeSingle();
    return data ? toCamel(data) : null;
  },
  async createSeason(data) {
    const {data: s, error} = await sb.from('seasons').insert(toSnake(data)).select().single();
    if (error) throw error;
    return toCamel(s);
  },
  async updateSeason(id, patch) {
    const {error} = await sb.from('seasons').update(toSnake(patch)).eq('id', id);
    return !error;
  },

  // --- Games ---
  async getGame(id) {
    const {data} = await sb.from('games').select('*').eq('id', id).single();
    return data ? toCamel(data) : null;
  },
  async leagueGames(leagueId, seasonId) {
    let q = sb.from('games').select('*').eq('league_id', leagueId);
    if (seasonId) q = q.eq('season_id', seasonId);
    const {data} = await q.order('puck_drop');
    return (data||[]).map(toCamel);
  },
  async createGame(data) {
    const {data: g, error} = await sb.from('games').insert(toSnake(data)).select().single();
    if (error) throw error;
    return toCamel(g);
  },
  async updateGame(id, patch) {
    const {error} = await sb.from('games').update(toSnake(patch)).eq('id', id);
    return !error;
  },
  async deleteGame(id) {
    const {error} = await sb.from('games').delete().eq('id', id);
    return !error;
  },

  // --- Picks ---
  async getPickForGame(userId, gameId) {
    const {data} = await sb.from('picks').select('*').eq('user_id', userId).eq('game_id', gameId).maybeSingle();
    return data ? toCamel(data) : null;
  },
  async getPick(id) {
    const {data} = await sb.from('picks').select('*').eq('id', id).single();
    return data ? toCamel(data) : null;
  },
  async createPick(data) {
    const {data: p, error} = await sb.from('picks').insert(toSnake(data)).select().single();
    if (error) throw error;
    return toCamel(p);
  },
  async updatePick(id, patch) {
    const {error} = await sb.from('picks').update(toSnake(patch)).eq('id', id);
    return !error;
  },
  async deletePick(id) {
    const {error} = await sb.from('picks').delete().eq('id', id);
    return !error;
  },
  async gamePicks(gameId) {
    const {data} = await sb.from('picks').select('*').eq('game_id', gameId);
    return (data||[]).map(toCamel);
  },
  async userPicks(userId, leagueId) {
    const {data} = await sb.from('picks').select('*').eq('user_id', userId).eq('league_id', leagueId)
      .order('submitted_at', {ascending: false});
    return (data||[]).map(toCamel);
  },

  // --- Results ---
  async getResult(gameId) {
    const {data} = await sb.from('results').select('*').eq('game_id', gameId).maybeSingle();
    return data ? toCamel(data) : null;
  },
  async saveResult(data) {
    const {error} = await sb.from('results').upsert(toSnake(data), {onConflict: 'game_id'});
    return !error;
  },

  // --- Players ---
  async getPlayers(leagueId) {
    const {data} = await sb.from('league_players').select('player_name').eq('league_id', leagueId);
    return (data||[]).map(r => r.player_name);
  },
  async setPlayers(leagueId, players) {
    const {error} = await sb.rpc('set_league_players', {p_league_id: leagueId, p_players: players});
    return !error;
  },
  async addPlayer(leagueId, name) {
    const {error} = await sb.from('league_players').insert({league_id: leagueId, player_name: name});
    return !error;
  },
  async removePlayer(leagueId, name) {
    const {error} = await sb.from('league_players').delete().eq('league_id', leagueId).eq('player_name', name);
    return !error;
  },

  // --- Ineligible Players ---
  async getIneligible(leagueId) {
    const {data} = await sb.from('ineligible_players').select('*').eq('league_id', leagueId);
    return (data||[]).map(r => ({...toCamel(r), player: r.player_name}));
  },
  async addIneligible(leagueId, playerName, note='') {
    const {error} = await sb.from('ineligible_players')
      .insert({league_id: leagueId, player_name: playerName, note, added_by: S.user?.id});
    return !error;
  },
  async removeIneligible(leagueId, playerName) {
    const {error} = await sb.from('ineligible_players')
      .delete().eq('league_id', leagueId).eq('player_name', playerName);
    return !error;
  },

  // --- Notifications ---
  async userNotifs(userId) {
    const {data} = await sb.from('notifications').select('*').eq('user_id', userId)
      .order('created_at', {ascending: false});
    return (data||[]).map(toCamel);
  },
  async markAllRead(userId) {
    await sb.from('notifications').update({read: true}).eq('user_id', userId).eq('read', false);
    S.unread = 0;
  },
  async broadcastNotif(leagueId, message, type='system') {
    await sb.rpc('broadcast_notif', {p_league_id: leagueId, p_message: message, p_type: type});
  },
};

// ===================== AUTH ================================
const Auth = {
  async login(emailOrUser, password) {
    let email = emailOrUser.trim();
    if (!email.includes('@')) {
      const {data} = await sb.from('profiles').select('email').eq('username', email).single();
      if (!data?.email) return {err: 'User not found. Try logging in with your email address.'};
      email = data.email;
    }
    try {
      const result = await Promise.race([
        sb.auth.signInWithPassword({email, password}),
        new Promise((_, rej) => setTimeout(() => rej(new Error('Login timed out ‚Äî check your internet connection and try again.')), 12000)),
      ]);
      if (result.error) return {err: result.error.message};
      return {user: result.data.user};
    } catch(err) { return {err: err.message}; }
  },
  async resetPassword(email) {
    const {error} = await sb.auth.resetPasswordForEmail(email.trim(), {
      redirectTo: window.location.href.split('?')[0],
    });
    if (error) return {err: error.message};
    return {ok: true};
  },
  async signInWithOAuth(provider) {
    const {error} = await sb.auth.signInWithOAuth({
      provider,
      options: { redirectTo: window.location.href.split('?')[0] },
    });
    if (error) toast(error.message, 'err');
  },
  async register({username, email, password}) {
    const {data, error} = await sb.auth.signUp({
      email: email.trim(), password,
      options: {data: {username: username.trim()}}
    });
    if (error) return {err: error.message};
    if (data.user && !data.session) return {err: 'Check your email to confirm your account, then log in.'};
    return {user: data.user};
  },
  async logout() {
    S.channels.forEach(ch => sb.removeChannel(ch));
    S.channels = [];
    S.timers.forEach(clearInterval);
    S.timers = [];
    await sb.auth.signOut();
    S.user = null; S.authUser = null; S.league = null;
    S.userLeagues = []; S.isAdmin = false; S.unread = 0;
    route('auth');
  },
  isLeagueAdmin(leagueId) {
    if (S.league?.id === leagueId) return S.isAdmin;
    return S.userLeagues.find(l => l.id === leagueId)?.myRole === 'admin';
  },
  requireAuth() { if (!S.user) { route('auth'); return false; } return true; },
};

// ===================== SCORING ==============================
const Score = {
  calc(pick, result) {
    if (!result) return {pts: null, breakdown: {}};
    const br = {}; let pts = 0;
    if (result.isShutout) {
      if (pick.isShutout) { br.shutout = 5; pts = 5; }
      return {pts, breakdown: br};
    }
    const dhScored = pick.darkhorse && pick.darkhorse === result.firstScorer;
    const regScored = !dhScored && pick.regular === result.firstScorer;
    const dhPt = pick.dhPlayType || pick.playType; // dhPlayType is the darkhorse's own play type prediction
    if (dhScored) {
      br.darkhorse = 3; pts += 3;
      if (dhPt === result.firstPlayType) { const pp = result.firstPlayType === 'pk' ? 3 : 1; br.playType = pp; pts += pp; }
      if (result.secondScorer && pick.regular === result.secondScorer) {
        br.bonusScorer = 1; pts += 1;
        if (pick.playType === result.secondPlayType) { const pp2 = result.secondPlayType === 'pk' ? 3 : 1; br.bonusPlayType = pp2; pts += pp2; }
      }
    } else if (regScored) {
      br.regular = 1; pts += 1;
      if (pick.playType === result.firstPlayType) { const pp = result.firstPlayType === 'pk' ? 3 : 1; br.playType = pp; pts += pp; }
    }
    pts = Math.min(pts, 8);
    return {pts, breakdown: br};
  },
};

// ===================== LEADERBOARD ==========================
async function computeLeaderboard(leagueId, seasonId) {
  const [members, games] = await Promise.all([
    DB.getLeagueMembers(leagueId),
    DB.leagueGames(leagueId, seasonId),
  ]);
  const completedIds = games.filter(g => g.status === 'completed').map(g => g.id);
  let picks = [];
  if (completedIds.length > 0) {
    const {data} = await sb.from('picks').select('*')
      .eq('league_id', leagueId).in('game_id', completedIds).eq('scored', true);
    picks = (data||[]).map(toCamel);
  }
  return members.map(m => {
    const mp = picks.filter(p => p.userId === m.userId);
    let pts=0, shutouts=0, darkhorses=0, played=0;
    mp.forEach(p => { if (p.pts != null) { pts += p.pts; if (p.breakdown?.shutout) shutouts++; if (p.breakdown?.darkhorse) darkhorses++; played++; } });
    return {...m, pts, shutouts, darkhorses, played};
  }).sort((a,b) => b.pts!==a.pts ? b.pts-a.pts : b.shutouts!==a.shutouts ? b.shutouts-a.shutouts : b.darkhorses!==a.darkhorses ? b.darkhorses-a.darkhorses : b.played-a.played);
}

// ===================== HELPERS ==============================
function uid() {
  return Date.now().toString(36) + Math.random().toString(36).slice(2, 7);
}

function fmtDate(ts) {
  return new Date(ts).toLocaleDateString('en-US', {month:'short', day:'numeric', year:'numeric'});
}

function fmtDateTime(ts) {
  return new Date(ts).toLocaleDateString('en-US', {
    month:'short', day:'numeric', hour:'numeric', minute:'2-digit', hour12:true
  });
}

function fmtTime(ts) {
  return new Date(ts).toLocaleTimeString('en-US', {hour:'numeric', minute:'2-digit', hour12:true});
}

function timeUntil(ts) {
  const diff = new Date(ts).getTime() - Date.now();
  if (diff <= 0) return null;
  const s = Math.floor(diff/1000);
  const m = Math.floor(s/60);
  const h = Math.floor(m/60);
  const d = Math.floor(h/24);
  if (d > 0) return `${d}d ${h%24}h`;
  if (h > 0) return `${h}h ${m%60}m`;
  if (m > 0) return `${m}m ${s%60}s`;
  return `${s}s`;
}

function countdownParts(ts) {
  const diff = Math.max(0, new Date(ts).getTime() - Date.now());
  const s = Math.floor(diff/1000);
  const m = Math.floor(s/60);
  const h = Math.floor(m/60);
  const d = Math.floor(h/24);
  return { d, h:h%24, m:m%60, s:s%60 };
}

function playTypeLabel(pt) {
  return {es:'Even Strength', pp:'Power Play', pk:'Penalty Kill'}[pt] || pt;
}
function playTypeShort(pt) {
  return {es:'ES', pp:'PP', pk:'PK'}[pt] || pt;
}

function esc(s) {
  if (!s) return '';
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}

function initials(name) {
  return name.split(' ').map(w=>w[0]||'').join('').toUpperCase().slice(0,2);
}

function applyTeamTheme(teamId) {
  const t = TEAMS[teamId];
  if (!t) return;
  const r = document.documentElement;
  r.style.setProperty('--tp', t.p);
  const hex = t.s === '#000000' ? t.p : t.s;
  r.style.setProperty('--ts', hex);
  // Compute glow from primary color
  const pr = parseInt(t.p.slice(1,3),16);
  const pg = parseInt(t.p.slice(3,5),16);
  const pb = parseInt(t.p.slice(5,7),16);
  r.style.setProperty('--tglow', `rgba(${pr},${pg},${pb},0.22)`);
  document.body.setAttribute('data-team', teamId);
}

// (Auth + Score + leaderboard defined above)

// (Score defined above)

// ===================== TOAST ================================
function toast(msg, type='info', dur=3000) {
  const el = document.createElement('div');
  el.className = `toast toast-${type}`;
  el.textContent = msg;
  const c = document.getElementById('toast-container');
  c.appendChild(el);
  setTimeout(() => { el.style.opacity='0'; el.style.transform='translateY(8px)';
    el.style.transition='all 0.3s'; setTimeout(()=>el.remove(), 300); }, dur);
}

// ===================== MODAL ================================
function openModal(html, title='') {
  const ov = document.getElementById('modal-overlay');
  const mc = document.getElementById('modal-content');
  mc.innerHTML = (title ? `<div class="modal-title">${esc(title)}</div>` : '') + html;
  ov.classList.add('open');
  // Close on backdrop click
  ov.onclick = e => { if (e.target === ov) closeModal(); };
}
function closeModal() {
  document.getElementById('modal-overlay').classList.remove('open');
}

// ===================== ROUTER ===============================
function route(view, params={}) {
  S.view = view;
  S.params = params;
  S.timers.forEach(clearInterval);
  S.timers = [];
  render().catch(err => { console.error('Render error:', err); toast('Something went wrong.', 'err'); });
}

async function render() {
  const sidebar = document.getElementById('sidebar');

  if (!S.user || S.view === 'auth') {
    sidebar.classList.add('hidden'); sidebar.innerHTML = '';
    renderAuth(); return;
  }
  if (S.view === 'team-select') { sidebar.classList.add('hidden'); renderTeamSelect(); return; }
  if (S.view === 'league-select') { sidebar.classList.add('hidden'); await renderLeagueSelect(); return; }

  if (S.user.teamId) applyTeamTheme(S.user.teamId);
  sidebar.classList.remove('hidden');
  sidebar.innerHTML = renderSidebar();

  switch(S.view) {
    case 'dashboard':      await renderDashboard(); break;
    case 'picks':          await renderPicksList(); break;
    case 'pick-entry':     await renderPickEntry(S.params.gameId); break;
    case 'standings':      await renderStandings(); break;
    case 'history':        await renderHistory(); break;
    case 'profile':        await renderProfile(); break;
    case 'notifications':  await renderNotifications(); break;
    case 'admin':          await renderAdmin(); break;
    default:               await renderDashboard();
  }
}

// ===================== NAV ==================================
function renderNav(active) {
  const isAdmin = S.isAdmin;
  return `
  <nav class="bottom-nav">
    <button class="nav-item ${active==='dashboard'?'active':''}" onclick="route('dashboard')">
      ${ico('home')}
      <span>Home</span>
    </button>
    <button class="nav-item ${active==='picks'?'active':''}" onclick="route('picks')">
      ${ico('target')}
      <span>Picks</span>
    </button>
    <button class="nav-item ${active==='standings'?'active':''}" onclick="route('standings')">
      ${ico('trophy')}
      <span>Standings</span>
    </button>
    <button class="nav-item ${active==='history'?'active':''}" onclick="route('history')">
      ${ico('clock')}
      <span>History</span>
    </button>
    ${isAdmin ? `<button class="nav-item ${active==='admin'?'active':''}" onclick="route('admin')">
      ${ico('shield')}
      <span>Admin</span>
    </button>` : `<button class="nav-item ${active==='profile'?'active':''}" onclick="route('profile')">
      ${ico('user')}
      <span>Profile</span>
    </button>`}
  </nav>`;
}

function renderSidebar() {
  const isAdmin = S.isAdmin;
  const league = S.league;
  const teamId = S.user?.teamId;
  const team = teamId ? TEAMS[teamId] : null;
  const items = [
    {v:'dashboard', label:'Home', icon:'home'},
    {v:'picks', label:'My Picks', icon:'target'},
    {v:'standings', label:'Standings', icon:'trophy'},
    {v:'history', label:'History', icon:'clock'},
    {v:'notifications', label:'Notifications', icon:'bell'},
    {v:'profile', label:'Profile', icon:'user'},
    ...(isAdmin ? [{v:'admin', label:'Admin Panel', icon:'shield'}] : []),
  ];
  return `
    <div class="sidebar-logo">FGOTG</div>
    ${league ? `<div style="padding:0 10px 16px;font-size:0.75rem;color:var(--t2);font-weight:600">${esc(league.name)}</div>` : ''}
    ${items.map(it => `
      <button class="sidebar-item ${S.view===it.v?'active':''}" onclick="route('${it.v}')">
        ${ico(it.icon)}
        <span>${it.label}</span>
      </button>
    `).join('')}
    <div style="flex:1"></div>
    <button class="sidebar-item" onclick="Auth.logout()">
      ${ico('logout')}
      <span>Logout</span>
    </button>
  `;
}

function renderHeader(title, showBack=false, showNotif=true) {
  return `
  <header class="hdr">
    ${showBack ? `<button class="hdr-btn" onclick="route('picks')" style="margin-right:4px">${ico('back')}</button>` : ''}
    <span class="hdr-logo">FGOTG</span>
    <span class="hdr-league">${title || (S.league ? esc(S.league.name) : '')}</span>
    <div class="hdr-actions">
      ${showNotif ? `<button class="hdr-btn" onclick="route('notifications')" title="Notifications">
        ${ico('bell')}
        ${S.unread > 0 ? '<span class="notif-badge"></span>' : ''}
      </button>` : ''}
      <button class="hdr-btn" onclick="route('profile')" title="Profile">
        <span style="font-size:0.75rem;font-weight:800">${initials(S.user?.username||'?')}</span>
      </button>
    </div>
  </header>`;
}

// ===================== ICONS ================================
function ico(name) {
  const icons = {
    home:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M3 9.5L12 3l9 6.5V20a1 1 0 01-1 1H4a1 1 0 01-1-1V9.5z"/><path stroke-linecap="round" stroke-linejoin="round" d="M9 21V12h6v9"/></svg>`,
    target:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>`,
    trophy:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M8 21h8M12 17v4M17 3H7l1 9a4 4 0 008 0l1-9z"/><path stroke-linecap="round" stroke-linejoin="round" d="M17 3c0 3 1.5 5 4 6M7 3C7 6 5.5 8 3 9"/></svg>`,
    clock:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="10"/><polyline stroke-linecap="round" stroke-linejoin="round" points="12 6 12 12 16 14"/></svg>`,
    bell:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M15 17h5l-2-2V9a6 6 0 00-12 0v6l-2 2h5m4 0v1a3 3 0 01-6 0v-1m6 0H9"/></svg>`,
    user:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M20 21v-2a4 4 0 00-4-4H8a4 4 0 00-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>`,
    shield:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 2L4 6v6c0 5.25 3.5 10.15 8 12 4.5-1.85 8-6.75 8-12V6L12 2z"/></svg>`,
    logout:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M17 16l4-4m0 0l-4-4m4 4H7M13 4H6a2 2 0 00-2 2v12a2 2 0 002 2h7"/></svg>`,
    back:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="20" height="20"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 18l-6-6 6-6"/></svg>`,
    plus:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="18" height="18"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/></svg>`,
    edit:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 4H4a2 2 0 00-2 2v14a2 2 0 002 2h14a2 2 0 002-2v-7M18 2l4 4-10 10H8v-4L18 2z"/></svg>`,
    trash:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="16" height="16"><polyline stroke-linecap="round" stroke-linejoin="round" stroke-width="2" points="3 6 5 6 21 6"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 6l-1 14a2 2 0 01-2 2H8a2 2 0 01-2-2L5 6m5 0V4a1 1 0 011-1h2a1 1 0 011 1v2"/></svg>`,
    check:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="16" height="16"><polyline stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" points="20 6 9 17 4 12"/></svg>`,
    lock:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="16" height="16"><rect stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x="3" y="11" width="18" height="11" rx="2"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 11V7a5 5 0 0110 0v4"/></svg>`,
    hockey:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="20" height="20"><ellipse cx="12" cy="19" rx="8" ry="2.5" stroke-width="1.5"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 19V8l4-4h4l4 4v11"/></svg>`,
    star:`<svg viewBox="0 0 24 24" fill="currentColor" width="14" height="14"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"/></svg>`,
    x:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="18" height="18"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 6L6 18M6 6l12 12"/></svg>`,
    info:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="16" height="16"><circle cx="12" cy="12" r="10"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 16v-4M12 8h.01"/></svg>`,
    calendar:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="16" height="16"><rect stroke-linecap="round" stroke-linejoin="round" stroke-width="2" x="3" y="4" width="18" height="18" rx="2"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 2v4M8 2v4M3 10h18"/></svg>`,
    settings:`<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" width="18" height="18"><circle cx="12" cy="12" r="3"/><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-4 0v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 010-4h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 012.83-2.83l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 014 0v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 2.83l-.06.06A1.65 1.65 0 0019.4 9a1.65 1.65 0 001.51 1H21a2 2 0 010 4h-.09a1.65 1.65 0 00-1.51 1z"/></svg>`,
  };
  return icons[name] || '';
}

// =================== LEAGUE HELPERS =========================
async function switchLeague(leagueId) {
  const league = S.userLeagues.find(l => l.id === leagueId);
  if (!league) return;
  S.league = league;
  S.isAdmin = league.myRole === 'admin';
  localStorage.setItem('fgotg_league', leagueId);
  if (S.user?.teamId) applyTeamTheme(S.user.teamId);
  await subscribeLeague(leagueId);
  route('dashboard');
}

async function joinLeague(leagueId) {
  const ok = await DB.addMember(leagueId, S.user.id, 'member');
  if (!ok) { toast('Could not join league', 'err'); return false; }
  S.userLeagues = await DB.getUserLeagues(S.user.id);
  const league = S.userLeagues.find(l => l.id === leagueId);
  if (league) {
    S.league = league;
    S.isAdmin = league.myRole === 'admin';
    localStorage.setItem('fgotg_league', leagueId);
    if (S.user?.teamId) applyTeamTheme(S.user.teamId);
    await subscribeLeague(leagueId);
  }
  return true;
}

async function createLeague(name, teamId, userId) {
  // 1. Insert league (no currentSeasonId yet)
  const league = await DB.createLeague({name, teamId, currentSeasonId: null});
  // 2. Creator becomes admin
  await DB.addMember(league.id, userId, 'admin');
  // 3. Create active season
  const season = await DB.createSeason({
    leagueId: league.id, name: '2024-25 Season', status: 'active',
    startDate: new Date().toISOString(),
  });
  // 4. Link season to league
  await DB.updateLeague(league.id, {currentSeasonId: season.id});
  // 5. Seed roster
  const roster = BASE_ROSTERS[teamId] || [];
  if (roster.length > 0) await DB.setPlayers(league.id, roster);
  // 6. Seed a demo game 7 days out so members can immediately submit picks
  const team = TEAMS[teamId];
  const candidates = ['Boston Bruins','Toronto Maple Leafs','Edmonton Oilers','Colorado Avalanche',
    'Florida Panthers','Tampa Bay Lightning','Vegas Golden Knights','New York Rangers','Carolina Hurricanes','Dallas Stars'];
  const opp = candidates.find(o => !o.toLowerCase().includes(team?.city?.toLowerCase()||'???')) || 'Boston Bruins';
  const puckDrop = new Date(Date.now() + 7*24*3600*1000).toISOString();
  const deadline  = new Date(Date.now() + 7*24*3600*1000 - 2*3600*1000).toISOString();
  await DB.createGame({leagueId: league.id, seasonId: season.id, opponent: opp,
    homeAway: 'home', puckDrop, deadline, status: 'upcoming'});
  // 7. Update state
  S.userLeagues = await DB.getUserLeagues(userId);
  S.league = S.userLeagues.find(l => l.id === league.id) || null;
  S.isAdmin = true;
  localStorage.setItem('fgotg_league', league.id);
  await subscribeLeague(league.id);
  return league;
}

// ==================== VIEW: AUTH ============================
function renderAuth() {
  document.getElementById('app').innerHTML = `
  <div class="page" style="max-width:420px">
    <div class="auth-hero">
      <div class="auth-logo">FGOTG</div>
      <div class="auth-tagline">First Goal of the Game ¬∑ NHL Prediction League</div>
    </div>
    <div id="auth-tabs" style="display:flex;border-bottom:1px solid var(--bdr);margin-bottom:24px">
      <button class="tab active" id="tab-login" onclick="authShowTab('login')">Login</button>
      <button class="tab" id="tab-register" onclick="authShowTab('register')">Sign Up</button>
    </div>
    <div id="auth-form-wrap"></div>
  </div>`;
  authShowTab('login');
}

function authShowTab(tab) {
  const tlEl = document.getElementById('tab-login');
  const trEl = document.getElementById('tab-register');
  if (tlEl) tlEl.classList.toggle('active', tab==='login');
  if (trEl) trEl.classList.toggle('active', tab==='register');
  const wrap = document.getElementById('auth-form-wrap');
  if (!wrap) return;

  if (tab === 'login') {
    wrap.innerHTML = `
    <div class="anim-slide-up">
      <form id="login-form" onsubmit="handleLogin(event)">
        <div class="form-group">
          <label class="form-label">Email or Username</label>
          <input class="form-input" id="l-email" type="text" placeholder="you@example.com" required autocomplete="username">
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input class="form-input" id="l-pw" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required autocomplete="current-password">
        </div>
        <div style="text-align:right;margin-bottom:12px">
          <button type="button" class="btn btn-ghost" style="font-size:0.8rem;padding:2px 0" onclick="authShowTab('forgot')">Forgot password?</button>
        </div>
        <div id="login-err" class="form-error" style="margin-bottom:12px"></div>
        <button type="submit" class="btn btn-primary btn-block btn-lg">Sign In</button>
      </form>
    </div>`;
  } else if (tab === 'register') {
    wrap.innerHTML = `
    <div class="anim-slide-up">
      <form id="reg-form" onsubmit="handleRegister(event)">
        <div class="form-group">
          <label class="form-label">Username</label>
          <input class="form-input" id="r-user" type="text" placeholder="GoalieSmash99" required minlength="3" maxlength="20">
        </div>
        <div class="form-group">
          <label class="form-label">Email</label>
          <input class="form-input" id="r-email" type="email" placeholder="you@example.com" required>
        </div>
        <div class="form-group">
          <label class="form-label">Password</label>
          <input class="form-input" id="r-pw" type="password" placeholder="Min 6 characters" required minlength="6">
        </div>
        <div id="reg-err" class="form-error" style="margin-bottom:12px"></div>
        <button type="submit" class="btn btn-primary btn-block btn-lg">Create Account</button>
      </form>
    </div>`;
  } else if (tab === 'forgot') {
    wrap.innerHTML = `
    <div class="anim-slide-up">
      <p class="text-sm text-muted mb-16">Enter your email and we'll send you a link to reset your password.</p>
      <form id="forgot-form" onsubmit="handleForgotPassword(event)">
        <div class="form-group">
          <label class="form-label">Email</label>
          <input class="form-input" id="forgot-email" type="email" placeholder="you@example.com" required autocomplete="email">
        </div>
        <div id="forgot-msg" style="margin-bottom:12px;font-size:0.85rem"></div>
        <button type="submit" class="btn btn-primary btn-block btn-lg">Send Reset Link</button>
        <button type="button" class="btn btn-ghost btn-block mt-8" onclick="authShowTab('login')">Back to Login</button>
      </form>
    </div>`;
  } else if (tab === 'reset') {
    wrap.innerHTML = `
    <div class="anim-slide-up">
      <p class="text-sm text-muted mb-16">Choose a new password.</p>
      <form id="reset-form" onsubmit="handleResetPassword(event)">
        <div class="form-group">
          <label class="form-label">New Password</label>
          <input class="form-input" id="new-pw" type="password" placeholder="Min 6 characters" required minlength="6" autocomplete="new-password">
        </div>
        <div id="reset-msg" style="margin-bottom:12px;font-size:0.85rem"></div>
        <button type="submit" class="btn btn-primary btn-block btn-lg">Set New Password</button>
      </form>
    </div>`;
  }
}

async function handleLogin(e) {
  e.preventDefault();
  const btn = e.target.querySelector('[type=submit]');
  btn.disabled = true; btn.textContent = 'Signing in‚Ä¶';
  const res = await Auth.login(
    document.getElementById('l-email').value.trim(),
    document.getElementById('l-pw').value
  );
  if (res.err) {
    document.getElementById('login-err').textContent = res.err;
    btn.disabled = false; btn.textContent = 'Sign In';
  }
  // On success, onAuthStateChange fires SIGNED_IN and calls afterLogin
}

async function handleForgotPassword(e) {
  e.preventDefault();
  const btn = e.target.querySelector('[type=submit]');
  const msg = document.getElementById('forgot-msg');
  btn.disabled = true; btn.textContent = 'Sending‚Ä¶';
  const res = await Auth.resetPassword(document.getElementById('forgot-email').value);
  if (res.err) {
    msg.style.color = 'var(--err)'; msg.textContent = res.err;
  } else {
    msg.style.color = 'var(--ok)'; msg.textContent = 'Reset link sent ‚Äî check your email.';
  }
  btn.disabled = false; btn.textContent = 'Send Reset Link';
}

async function handleResetPassword(e) {
  e.preventDefault();
  const btn = e.target.querySelector('[type=submit]');
  const msg = document.getElementById('reset-msg');
  btn.disabled = true; btn.textContent = 'Saving‚Ä¶';
  const {error} = await sb.auth.updateUser({password: document.getElementById('new-pw').value});
  if (error) {
    msg.style.color = 'var(--err)'; msg.textContent = error.message;
    btn.disabled = false; btn.textContent = 'Set New Password';
  } else {
    toast('Password updated! Signing you in‚Ä¶', 'ok');
    // onAuthStateChange will fire SIGNED_IN and redirect to dashboard
  }
}

async function handleRegister(e) {
  e.preventDefault();
  const btn = e.target.querySelector('[type=submit]');
  btn.disabled = true; btn.textContent = 'Creating account‚Ä¶';
  const res = await Auth.register({
    username: document.getElementById('r-user').value.trim(),
    email:    document.getElementById('r-email').value.trim(),
    password: document.getElementById('r-pw').value,
  });
  if (res.err) {
    document.getElementById('reg-err').textContent = res.err;
    btn.disabled = false; btn.textContent = 'Create Account';
  }
}

async function afterLogin(authUser) {
  const profile = await DB.getProfile(authUser.id);
  if (!profile) {
    // Profile may not exist yet (trigger runs async) ‚Äî retry once after a short delay
    await new Promise(r => setTimeout(r, 1200));
    S.user = await DB.getProfile(authUser.id);
  } else {
    S.user = profile;
  }
  S.authUser = authUser;
  if (!S.user) { toast('Profile not found. Please try again.', 'err'); return; }

  S.userLeagues = await DB.getUserLeagues(authUser.id);
  const savedId = localStorage.getItem('fgotg_league');
  const saved = savedId ? S.userLeagues.find(l => l.id === savedId) : null;
  S.league = saved || S.userLeagues[0] || null;
  S.isAdmin = S.league?.myRole === 'admin' || false;

  const {count} = await sb.from('notifications')
    .select('id', {count: 'exact', head: true})
    .eq('user_id', authUser.id).eq('read', false);
  S.unread = count || 0;

  if (S.user.teamId) applyTeamTheme(S.user.teamId);
  if (S.league) await subscribeLeague(S.league.id);

  if (!S.user.teamId) { route('team-select'); return; }
  if (!S.userLeagues.length) { route('league-select'); return; }
  route('dashboard');
}

// ==================== VIEW: TEAM SELECT =====================
function renderTeamSelect() {
  document.getElementById('app').innerHTML = `
  ${renderHeader('Choose Your Team', false, false)}
  <div class="page anim-slide-up">
    <p class="text-sm text-muted mt-12 mb-4" style="text-align:center">Pick the NHL team whose games you'll follow all season.</p>
    <div class="team-grid" id="team-grid">
      ${TEAMS_SORTED.map(id => {
        const t = TEAMS[id];
        return `<button class="team-tile" id="tt-${id}" onclick="selectTeam('${id}')"
          style="--tc:${t.p}">
          <span class="team-emoji">${t.e}</span>
          <span class="team-abbr" style="color:${t.p}">${t.abbr}</span>
          <span style="font-size:0.6rem;color:var(--t2);text-align:center;line-height:1.2">${t.city}</span>
        </button>`;
      }).join('')}
    </div>
    <div id="team-confirm" style="display:none;margin-top:16px">
      <div class="card card-glow" id="team-preview" style="text-align:center;padding:20px"></div>
      <button class="btn btn-primary btn-block btn-lg mt-12" id="confirm-team-btn" onclick="confirmTeam()">
        Confirm Team & Continue
      </button>
    </div>
  </div>`;
  window._selectedTeam = null;
}

function selectTeam(id) {
  window._selectedTeam = id;
  document.querySelectorAll('.team-tile').forEach(el => el.classList.remove('selected'));
  document.getElementById(`tt-${id}`)?.classList.add('selected');
  applyTeamTheme(id);
  const t = TEAMS[id];
  const conf = document.getElementById('team-confirm');
  conf.style.display = 'block';
  document.getElementById('team-preview').innerHTML = `
    <div style="font-size:3rem">${t.e}</div>
    <div class="text-lg mt-8" style="color:var(--tp)">${t.name}</div>
    <div class="text-sm text-muted mt-4">You'll follow the ${t.city} games this season</div>`;
}

async function confirmTeam() {
  if (!window._selectedTeam) return;
  await DB.updateProfile(S.user.id, {teamId: window._selectedTeam});
  applyTeamTheme(window._selectedTeam);
  route('league-select');
}

// ==================== VIEW: LEAGUE SELECT ===================
async function renderLeagueSelect() {
  const teamId = S.user.teamId;
  const team = TEAMS[teamId];
  document.getElementById('app').innerHTML = `${renderHeader('Join a League', false, false)}
    <div class="page"><div class="empty mt-24"><div class="empty-icon">üèí</div><div class="empty-title">Loading leagues‚Ä¶</div></div></div>`;

  const [allLeagues] = await Promise.all([DB.getAllLeaguesForTeam(teamId)]);
  const userLeagueIds = new Set(S.userLeagues.map(l => l.id));

  document.getElementById('app').innerHTML = `
  ${renderHeader('Join a League', false, false)}
  <div class="page anim-slide-up">
    <div class="season-banner mt-16">
      <div class="text-lg">${team?.e || ''} ${esc(team?.name || '')}</div>
      <div class="text-sm text-muted mt-4">Find a league or create your own</div>
    </div>

    ${allLeagues.length > 0 ? `
    <div class="section-label">Open Leagues for ${esc(team?.city||'')} Fans</div>
    ${allLeagues.map(l => {
      const isMember = userLeagueIds.has(l.id);
      const memberCount = l.memberCount || 0;
      return `
      <div class="card card-clickable mb-8" onclick="${isMember ? `switchLeague('${l.id}')` : `joinAndGo('${l.id}')`}">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-md">${esc(l.name)}</div>
            <div class="text-xs text-muted mt-4">${memberCount} member${memberCount!==1?'s':''}</div>
          </div>
          ${isMember ? '<span class="pill pill-ok">Joined</span>' : '<button class="btn btn-primary btn-sm">Join</button>'}
        </div>
      </div>`;
    }).join('')}` : `<div class="empty" style="padding:32px 0"><div class="empty-icon">üèí</div><div class="empty-title">No leagues yet</div><div class="empty-sub">Be the first to create a league for ${team?.name||'your team'}!</div></div>`}

    <div class="divider-label">or</div>
    <div class="card">
      <div class="text-md mb-12">Create a New League</div>
      <div class="form-group">
        <label class="form-label">League Name</label>
        <input class="form-input" id="new-league-name" placeholder="e.g. Leafs Nation Fantasy" maxlength="40">
      </div>
      <button class="btn btn-secondary btn-block" onclick="handleCreateLeague()">
        ${ico('plus')} Create League
      </button>
    </div>

    ${S.userLeagues.length > 0 ? `
    <div class="text-center mt-16">
      <button class="btn btn-ghost" onclick="skipToApp()">Continue to existing league ‚Üí</button>
    </div>` : ''}
  </div>`;
}

async function joinAndGo(leagueId) {
  const ok = await joinLeague(leagueId);
  if (ok) { toast('Joined league!', 'ok'); route('dashboard'); }
}

async function handleCreateLeague() {
  const name = document.getElementById('new-league-name')?.value.trim();
  if (!name) { toast('Enter a league name', 'err'); return; }
  try {
    await createLeague(name, S.user.teamId, S.user.id);
    toast(`League "${name}" created!`, 'ok');
    route('dashboard');
  } catch(err) { toast('Could not create league: ' + err.message, 'err'); }
}

function skipToApp() {
  if (S.userLeagues.length > 0) { S.league = S.userLeagues[0]; S.isAdmin = S.league.myRole==='admin'; }
  route('dashboard');
}

// ==================== VIEW: DASHBOARD =======================
async function renderDashboard() {
  if (!S.league) { route('league-select'); return; }
  const league = S.league;
  const team = TEAMS[S.user.teamId];
  const now = Date.now();

  const season = await DB.activeSeason(league.id);
  const allGames = season ? await DB.leagueGames(league.id, season.id) : [];

  const upcoming = allGames
    .filter(g => g.status !== 'completed' && new Date(g.puckDrop).getTime() > now - 3600000)
    .sort((a,b) => new Date(a.puckDrop) - new Date(b.puckDrop)).slice(0, 5);
  const nextGame = upcoming[0] || null;
  const isLocked = nextGame && (nextGame.status === 'locked' || now >= new Date(nextGame.deadline).getTime());

  const [myNextPick, allMyPicks, lb] = await Promise.all([
    nextGame ? DB.getPickForGame(S.user.id, nextGame.id) : Promise.resolve(null),
    DB.userPicks(S.user.id, league.id),
    season ? computeLeaderboard(league.id, season.id) : Promise.resolve([]),
  ]);
  const recentPicks = allMyPicks.filter(p => p.pts != null).slice(0, 3);
  const myRank = lb.findIndex(e => e.userId === S.user.id) + 1;
  const myEntry = lb.find(e => e.userId === S.user.id);
  const myStats = myEntry ? {pts: myEntry.pts, shutouts: myEntry.shutouts, darkhorses: myEntry.darkhorses, played: myEntry.played} : null;

  document.getElementById('app').innerHTML = `
  ${renderHeader()}
  <div class="page page-enter" style="padding-top:12px">

    ${season ? '' : `<div class="card" style="background:rgba(245,158,11,0.08);border-color:rgba(245,158,11,0.3);margin-bottom:12px">
      <div class="flex items-center gap-8"><span style="font-size:1.2rem">‚ö†Ô∏è</span><div>
        <div class="text-sm fw-bold">No active season</div>
        <div class="text-xs text-muted mt-4">${Auth.isLeagueAdmin(league.id) ? 'Go to the Admin tab ‚Üí Season to start one.' : 'An admin needs to start a season first.'}</div>
        ${Auth.isLeagueAdmin(league.id) ? `<button class="btn btn-primary btn-sm mt-8" onclick="route('admin',{adminTab:'season'})">Open Admin ‚Üí Season</button>` : ''}
      </div></div>
    </div>`}

    ${season && nextGame ? renderNextGameCard(nextGame, myNextPick, isLocked, team) : season ? `
    <div class="card mb-12" style="text-align:center;padding:28px 20px">
      <div style="font-size:2.8rem">üèí</div>
      <div class="text-md mt-12">No upcoming games scheduled</div>
      ${S.isAdmin ? `
        <div class="text-xs text-muted mt-8">You're the league admin ‚Äî add games so members can start picking!</div>
        <button class="btn btn-primary mt-16" onclick="route('admin',{adminTab:'games'})">Go to Admin ‚Üí Add Games</button>
      ` : `<div class="text-xs text-muted mt-8">Check back when the admin schedules games</div>`}
    </div>` : ''}

    ${myStats && (myStats.played > 0) ? `
    <div class="section-label">Your Season Stats</div>
    <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px">
      <div class="card card-sm text-center">
        <div class="score-badge" style="font-size:1.4rem">${myStats.pts}<span>pts</span></div>
        <div class="text-xs text-muted mt-4">Total Points</div>
      </div>
      <div class="card card-sm text-center">
        <div class="score-badge" style="font-size:1.4rem;color:var(--gold)">${myRank || '‚Äì'}<span style="color:var(--t1)">#</span></div>
        <div class="text-xs text-muted mt-4">Rank</div>
      </div>
      <div class="card card-sm text-center">
        <div class="score-badge" style="font-size:1.4rem;color:var(--ok)">${myStats.played}<span style="color:var(--t1)">gp</span></div>
        <div class="text-xs text-muted mt-4">Games Picked</div>
      </div>
    </div>` : ''}

    ${recentPicks.length > 0 ? `
    <div class="section-label">Recent Results</div>
    ${recentPicks.map(p => {
      const g = null; // games pre-fetched below; click opens history
      const r = null;
      return `
      <div class="card card-sm mb-8" onclick="route('history')" style="cursor:pointer">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm">${g ? `vs ${esc(g.opponent)}` : 'Game'}</div>
            <div class="text-xs text-muted">${g ? fmtDate(g.puckDrop) : ''}</div>
          </div>
          <div class="flex items-center gap-8">
            ${r?.isShutout ? '<span class="pill pill-blue">ü•Ö Shutout</span>' : ''}
            <div class="score-badge" style="font-size:1.3rem;${p.pts > 0 ? 'color:var(--ok)' : 'color:var(--t2)'}">
              ${p.pts}<span>pts</span>
            </div>
          </div>
        </div>
      </div>`;
    }).join('')}` : ''}

    ${upcoming.slice(1).length > 0 ? `
    <div class="section-label">Upcoming Games</div>
    ${upcoming.slice(1).map(g => {
      const myPick = allMyPicks.find(p => p.gameId === g.id) || null;
      const locked = g.status === 'locked' || Date.now() >= new Date(g.deadline).getTime();
      return `
      <div class="card card-sm card-clickable mb-8" onclick="route('pick-entry',{gameId:'${g.id}'})">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm fw-bold">vs ${esc(g.opponent)}</div>
            <div class="text-xs text-muted">${fmtDateTime(g.puckDrop)} ¬∑ Deadline ${fmtTime(g.deadline)}</div>
          </div>
          ${myPick ? '<span class="pill pill-ok">‚úì Picked</span>'
            : locked ? '<span class="pill pill-gray">' + ico('lock') + ' Locked</span>'
            : '<span class="pill pill-warn">Pick due</span>'}
        </div>
      </div>`;
    }).join('')}` : ''}

    ${S.unread > 0 ? `
    <div class="card card-sm card-clickable mb-8" onclick="route('notifications')" style="border-color:rgba(59,130,246,0.3);background:rgba(59,130,246,0.06)">
      <div class="flex items-center gap-8">
        <span>${ico('bell')}</span>
        <span class="text-sm">You have ${S.unread} unread notification${S.unread!==1?'s':''}</span>
        <span class="pill pill-blue" style="margin-left:auto">${S.unread}</span>
      </div>
    </div>` : ''}

    <!-- League Switcher -->
    ${S.userLeagues.length > 1 ? `
    <div class="section-label">Your Leagues</div>
    ${S.userLeagues.map(l => {
      const lid = l.id;
      const t = TEAMS[l.teamId];
      return `<div class="card card-sm card-clickable mb-8" onclick="switchLeague('${lid}')">
        <div class="flex items-center gap-8">
          <span>${t?.e||'üèí'}</span>
          <span class="text-sm">${esc(l.name)}</span>
          ${S.league.id === lid ? '<span class="pill pill-ok" style="margin-left:auto">Active</span>' : ''}
        </div>
      </div>`;
    }).join('')}
    <button class="btn btn-ghost btn-sm mt-4" onclick="route('league-select')">+ Join another league</button>
    ` : ''}

  </div>
  ${renderNav('dashboard')}`;

  // Start countdown timer
  if (nextGame && !isLocked) {
    const timer = setInterval(() => {
      const el = document.getElementById('next-game-countdown');
      if (!el) { clearInterval(timer); return; }
      const locked = Date.now() >= new Date(nextGame.deadline).getTime();
      if (locked) { clearInterval(timer); el.innerHTML = '<span class="pill pill-err">' + ico('lock') + ' PICKS LOCKED</span>'; return; }
      const {d,h,m,s} = countdownParts(nextGame.deadline);
      el.innerHTML = `
        <div class="countdown-wrap" style="padding:8px 0">
          ${d>0?`<div class="countdown-block"><div class="countdown-num">${d}</div><div class="countdown-lbl">days</div></div>`:''}
          <div class="countdown-block"><div class="countdown-num">${String(h).padStart(2,'0')}</div><div class="countdown-lbl">hrs</div></div>
          <div class="countdown-block"><div class="countdown-num">${String(m).padStart(2,'0')}</div><div class="countdown-lbl">min</div></div>
          <div class="countdown-block"><div class="countdown-num">${String(s).padStart(2,'0')}</div><div class="countdown-lbl">sec</div></div>
        </div>`;
    }, 1000);
    S.timers.push(timer);
  }
}

function renderNextGameCard(game, myPick, isLocked, team) {
  const puckTime = fmtDateTime(game.puckDrop);
  const {d,h,m,s} = countdownParts(game.deadline);
  const deadlineLabel = fmtTime(game.deadline);

  return `
  <div class="game-card card-glow mb-12" style="animation:pulse-glow 3s ease infinite">
    <div class="game-card-header">
      <div>
        <div class="text-xs text-muted">NEXT GAME</div>
        <div class="game-vs">${esc(team?.abbr||'')} vs ${esc(game.opponent)}</div>
        <div class="game-time">${puckTime}</div>
      </div>
      ${myPick
        ? '<span class="pill pill-ok">‚úì Pick Submitted</span>'
        : isLocked
          ? '<span class="pill pill-err">' + ico('lock') + ' Locked</span>'
          : '<span class="pill pill-warn">Pick Required</span>'}
    </div>
    <div class="game-card-body">
      ${myPick ? renderPickSummarySmall(myPick) : `
        <div class="text-xs text-muted mb-8">Deadline: ${deadlineLabel}</div>
        <div id="next-game-countdown">
          <div class="countdown-wrap">
            ${d>0?`<div class="countdown-block"><div class="countdown-num">${d}</div><div class="countdown-lbl">days</div></div>`:''}
            <div class="countdown-block"><div class="countdown-num">${String(h).padStart(2,'0')}</div><div class="countdown-lbl">hrs</div></div>
            <div class="countdown-block"><div class="countdown-num">${String(m).padStart(2,'0')}</div><div class="countdown-lbl">min</div></div>
            <div class="countdown-block"><div class="countdown-num">${String(s).padStart(2,'0')}</div><div class="countdown-lbl">sec</div></div>
          </div>
        </div>
        ${!isLocked ? `<button class="btn btn-primary btn-block mt-12" onclick="route('pick-entry',{gameId:'${game.id}'})">Make Your Pick ‚Üí</button>` : ''}`}
    </div>
  </div>`;
}

function renderPickSummarySmall(pick) {
  return `
  <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
    <div class="pick-slot">
      <div class="pick-slot-icon" style="background:var(--tglow)">${ico('target')}</div>
      <div>
        <div class="pick-slot-label">Regular</div>
        <div class="pick-slot-value">${esc(pick.regular)}</div>
      </div>
    </div>
    <div class="pick-slot">
      <div class="pick-slot-icon" style="background:rgba(139,92,246,0.2)">üéØ</div>
      <div>
        <div class="pick-slot-label">${pick.isShutout ? 'Shutout' : 'Darkhorse'}</div>
        <div class="pick-slot-value">${pick.isShutout ? 'ü•Ö Shutout' : esc(pick.darkhorse)}</div>
      </div>
    </div>
  </div>
  <div class="pick-slot mt-8">
    <div class="pick-slot-icon" style="background:var(--surf3)">‚ö°</div>
    <div>
      <div class="pick-slot-label">Play Type</div>
      <div class="pick-slot-value">${playTypeLabel(pick.playType)}</div>
    </div>
  </div>`;
}

// ==================== VIEW: PICK ENTRY ======================
async function renderPickEntry(gameId) {
  if (!gameId) { route('picks'); return; }

  const game = await DB.getGame(gameId);
  if (!game) { toast('Game not found', 'err'); route('picks'); return; }

  const leagueId = game.leagueId || S.league?.id;
  const team = TEAMS[S.user.teamId];
  const isLocked = game.status === 'locked' || Date.now() >= new Date(game.deadline).getTime();
  const isEditing = !!S.params.editing;

  const [existingPick, result, players, ineligibleRaw] = await Promise.all([
    DB.getPickForGame(S.user.id, gameId),
    DB.getResult(gameId),
    DB.getPlayers(leagueId),
    DB.getIneligible(leagueId),
  ]);
  const ineligible = ineligibleRaw.map(i => i.playerName);
  const showForm = !isLocked && (!existingPick || isEditing);

  document.getElementById('app').innerHTML = `
  ${renderHeader(`vs ${esc(game.opponent)}`, true)}
  <div class="page page-enter" style="padding-top:12px">

    <div class="card mb-16">
      <div class="flex items-center justify-between mb-8">
        <div>
          <div class="text-xs text-muted">GAME</div>
          <div class="text-lg">${esc(team?.abbr||'')} vs ${esc(game.opponent)}</div>
        </div>
        ${isLocked ? '<span class="pill pill-err">' + ico('lock') + ' LOCKED</span>'
          : existingPick && !isEditing ? '<span class="pill pill-ok">‚úì Submitted</span>'
          : '<span class="pill pill-warn">Open</span>'}
      </div>
      <div class="text-xs text-muted">üèí Puck Drop: ${fmtDateTime(game.puckDrop)}</div>
      <div class="text-xs text-muted mt-4">‚è∞ Pick Deadline: ${fmtDateTime(game.deadline)}</div>
    </div>

    ${result ? renderResultBanner(result) : ''}

    ${result && existingPick ? renderPickResult(existingPick, result) : ''}

    ${!result && existingPick && isLocked ? `
    <div class="section-label">Your Picks</div>
    ${renderPickSummaryFull(existingPick)}
    <div class="text-center text-xs text-muted mt-12">Waiting for game result to be posted...</div>
    ` : ''}

    ${!result && existingPick && !isLocked && !isEditing ? `
    <div class="section-label">Your Picks</div>
    ${renderPickSummaryFull(existingPick)}
    <div class="flex gap-8 justify-center mt-12">
      <button class="btn btn-ghost btn-sm" onclick="startEditPick('${gameId}')">‚úèÔ∏è Change Pick</button>
      <button class="btn btn-ghost btn-sm" style="color:var(--err)" onclick="confirmDeletePick('${existingPick.id}','${gameId}')">üóë Delete Pick</button>
    </div>` : ''}

    ${showForm ? renderPickForm(gameId, players, ineligible) : ''}

  </div>
  ${renderNav('picks')}`;

  if (showForm && isEditing && existingPick) {
    prefillPickForm(existingPick);
  }
}

function renderResultBanner(result) {
  if (result.isShutout) {
    return `<div class="result-banner shutout mb-12">
      <span class="result-icon">ü•Ö</span>
      <div><div class="text-md">Shutout!</div><div class="text-xs text-muted">No goals scored in this game</div></div>
    </div>`;
  }
  return `<div class="result-banner goal mb-12">
    <span class="result-icon">üö®</span>
    <div>
      <div class="text-md">${esc(result.firstScorer)}</div>
      <div class="text-xs text-muted">First goal ¬∑ ${playTypeLabel(result.firstPlayType)}</div>
      ${result.secondScorer ? `<div class="text-xs text-muted mt-4">2nd goal: ${esc(result.secondScorer)} ¬∑ ${playTypeLabel(result.secondPlayType)}</div>` : ''}
    </div>
  </div>`;
}

function renderPickResult(pick, result) {
  const {pts, breakdown} = Score.calc(pick, result);
  const rows = [
    {label: 'Regular Pick', val: esc(pick.regular), pts: breakdown.regular||0,
     correct: result.isShutout ? null : pick.regular === result.firstScorer && !breakdown.darkhorse},
    pick.isShutout
      ? {label: 'Shutout Call', val: 'ü•Ö Shutout', pts: breakdown.shutout||0, correct: !!breakdown.shutout}
      : {label: 'Darkhorse Pick', val: esc(pick.darkhorse), pts: breakdown.darkhorse||0,
         correct: result.isShutout ? null : pick.darkhorse === result.firstScorer},
    {label: 'Play Type', val: playTypeLabel(breakdown.darkhorse ? (pick.dhPlayType||pick.playType) : pick.playType), pts: breakdown.playType||0,
     correct: !result.isShutout && (breakdown.darkhorse ? (pick.dhPlayType||pick.playType) : pick.playType) === result.firstPlayType},
  ];
  if (breakdown.bonusScorer != null) {
    rows.push({label: 'Bonus: 2nd Goal Scorer', val: esc(pick.regular), pts: breakdown.bonusScorer, correct: true});
    rows.push({label: 'Bonus: 2nd Goal Play Type', val: playTypeLabel(pick.playType), pts: breakdown.bonusPlayType||0, correct: pick.playType === result.secondPlayType});
  }

  return `
  <div class="section-label">Your Result</div>
  <div class="card mb-16">
    <div class="text-center" style="padding:12px 0 16px">
      <div class="score-badge">${pts}<span>pts</span></div>
      <div class="text-xs text-muted mt-4">out of 8 max</div>
    </div>
    ${rows.map(r => `
    <div class="breakdown-row">
      <div>
        <div class="text-sm">${r.label}</div>
        <div class="text-xs text-muted">${r.val}</div>
      </div>
      <div class="flex items-center gap-8">
        ${r.correct === true ? '<span style="color:var(--ok)">' + ico('check') + '</span>'
          : r.correct === false ? '<span style="color:var(--err)">' + ico('x') + '</span>' : ''}
        <div class="breakdown-pts ${r.pts===0?'zero':''}">+${r.pts}</div>
      </div>
    </div>`).join('')}
  </div>`;
}

function renderPickSummaryFull(pick) {
  if (!pick) return '<div class="empty"><div class="empty-icon">üéØ</div><div class="empty-title">No pick submitted</div></div>';
  return `
  <div class="card mb-12">
    <div class="pick-slot mb-8">
      <div class="pick-slot-icon" style="background:var(--tglow)">${ico('target')}</div>
      <div class="flex-1">
        <div class="pick-slot-label">Regular Pick</div>
        <div class="pick-slot-value">${esc(pick.regular)}</div>
      </div>
    </div>
    <div class="pick-slot mb-8">
      <div class="pick-slot-icon" style="background:rgba(139,92,246,0.2)">üéØ</div>
      <div class="flex-1">
        <div class="pick-slot-label">${pick.isShutout ? 'Shutout Call' : 'Darkhorse Pick'}</div>
        <div class="pick-slot-value">${pick.isShutout ? 'ü•Ö Called Shutout' : esc(pick.darkhorse)}</div>
      </div>
    </div>
    <div class="pick-slot">
      <div class="pick-slot-icon" style="background:var(--surf3)">‚ö°</div>
      <div class="flex-1">
        <div class="pick-slot-label">Regular Play Type</div>
        <div class="pick-slot-value">${playTypeLabel(pick.playType)}</div>
      </div>
    </div>
    ${!pick.isShutout ? `
    <div class="pick-slot">
      <div class="pick-slot-icon" style="background:var(--surf3)">‚ö°</div>
      <div class="flex-1">
        <div class="pick-slot-label">Darkhorse Play Type</div>
        <div class="pick-slot-value">${playTypeLabel(pick.dhPlayType||'es')}</div>
      </div>
    </div>` : ''}
    <div class="text-xs text-muted mt-8" style="text-align:right">Submitted ${fmtDateTime(pick.submittedAt)}</div>
  </div>`;
}

function renderPickForm(gameId, players, ineligible) {
  window._pickState = { gameId, regular: '', darkhorse: '', isShutout: false, playType: 'es', dhPlayType: 'es' };
  const sortedPlayers = [...players].sort();
  const ptBtns = (id, fn) => `
    <div class="toggle-group mb-12" id="${id}">
      <button class="toggle-item active" onclick="${fn}('es',this)">Even Str.</button>
      <button class="toggle-item" onclick="${fn}('pp',this)">Power Play</button>
      <button class="toggle-item" onclick="${fn}('pk',this)" title="Shorthanded goal = +3 pts">Pen. Kill üåü</button>
    </div>`;

  return `
  <div id="pick-form">

    <div class="card mb-16" style="border-color:var(--tp,var(--bdr2))">
      <div class="section-label" style="margin-top:0;margin-bottom:8px">üèí GS ‚Äî Goal Scorer <span style="font-size:0.72rem;font-weight:400;opacity:0.6">(1 pt)</span></div>
      <div class="text-xs text-muted mb-8">Who do you think scores first?</div>
      <div class="player-search-wrap form-group">
        <input class="form-input" id="regular-input" type="text" placeholder="Tap to browse or search by name‚Ä¶"
          oninput="filterPlayers('regular-input','regular-dropdown','regular')"
          onfocus="filterPlayers('regular-input','regular-dropdown','regular')" autocomplete="off">
        <div class="player-dropdown hidden" id="regular-dropdown">
          ${sortedPlayers.map(p => `
          <div class="player-option" onclick="selectPlayer('regular','${esc(p)}')">
            <span>${esc(p)}</span>
          </div>`).join('')}
        </div>
      </div>
      <div class="text-xs text-muted mb-4">Play type:</div>
      ${ptBtns('play-type-group', 'setPlayType')}
    </div>

    <div class="card mb-16" style="border-color:rgba(139,92,246,0.35)">
      <div class="section-label" style="margin-top:0;margin-bottom:8px">üéØ DH ‚Äî Darkhorse <span style="font-size:0.72rem;font-weight:400;opacity:0.6">(3 pts ¬∑ or call Shutout for 5 pts)</span></div>
      <div class="dh-toggle" style="margin-bottom:14px">
        <div class="dh-toggle-opt active" id="dh-opt" onclick="setDarkSide('darkhorse')">üéØ Darkhorse Pick</div>
        <div class="dh-toggle-opt" id="so-opt" onclick="setDarkSide('shutout')">ü•Ö Shutout Call</div>
      </div>
      <div id="darkhorse-section">
        <div class="text-xs text-muted mb-8">Surprise scorer ‚Äî must be different from GS.</div>
        <div class="player-search-wrap form-group">
          <input class="form-input" id="darkhorse-input" type="text" placeholder="Tap to browse or search by name‚Ä¶"
            oninput="filterPlayers('darkhorse-input','darkhorse-dropdown','darkhorse')"
            onfocus="filterPlayers('darkhorse-input','darkhorse-dropdown','darkhorse')" autocomplete="off">
          <div class="player-dropdown hidden" id="darkhorse-dropdown">
            ${sortedPlayers.map(p => {
              const isInelig = ineligible.includes(p);
              return `<div class="player-option" onclick="${isInelig ? '' : `selectPlayer('darkhorse','${esc(p)}')`}" style="${isInelig ? 'opacity:0.4;cursor:not-allowed' : ''}">
                <span>${esc(p)}</span>
                ${isInelig ? '<span class="inelig-badge">Ineligible</span>' : ''}
              </div>`;
            }).join('')}
          </div>
        </div>
        <div class="text-xs text-muted mb-4">Play type:</div>
        ${ptBtns('dh-play-type-group', 'setDhPlayType')}
      </div>
      <div id="shutout-section" class="hidden" style="padding:8px 0 4px">
        <div class="flex items-center gap-12">
          <span style="font-size:2rem">ü•Ö</span>
          <div>
            <div class="text-md">Calling Shutout</div>
            <div class="text-xs text-muted">No goals scored. Worth 5 pts if correct.</div>
          </div>
        </div>
      </div>
    </div>

    <div id="pick-validation" class="form-error mb-8"></div>
    <button class="btn btn-primary btn-block btn-lg" id="submit-pick-btn" onclick="submitPick()">
      Lock In My Pick
    </button>
    <div class="text-xs text-dim text-center mt-8">Picks lock at deadline ¬∑ Max 8 pts per game</div>
  </div>`;
}

async function filterPlayers(inputId, dropdownId, slot) {
  const query = document.getElementById(inputId).value.toLowerCase();
  const dd = document.getElementById(dropdownId);
  dd.classList.remove('hidden');
  const leagueId = S.league?.id;
  const [players, ineligibleRaw] = await Promise.all([DB.getPlayers(leagueId), DB.getIneligible(leagueId)]);
  const ineligible = ineligibleRaw.map(i => i.playerName);

  const filtered = [...players].sort().filter(p => !query || p.toLowerCase().includes(query));
  dd.innerHTML = filtered.length === 0
    ? '<div class="player-option text-dim">No players found</div>'
    : filtered.map(p => {
        const isInelig = slot === 'darkhorse' && ineligible.includes(p);
        return `<div class="player-option" onclick="${isInelig ? '' : `selectPlayer('${slot}','${esc(p)}')`}"
          style="${isInelig ? 'opacity:0.45;cursor:not-allowed' : ''}">
          <span>${esc(p)}</span>
          ${isInelig ? '<span class="inelig-badge">Ineligible</span>' : ''}
        </div>`;
      }).join('');
}

function selectPlayer(slot, name) {
  window._pickState[slot] = name;
  const inputId = slot + '-input';
  const dropdownId = slot + '-dropdown';
  document.getElementById(inputId).value = name;
  document.getElementById(dropdownId)?.classList.add('hidden');
  // Validate same player
  if (window._pickState.regular && window._pickState.darkhorse &&
      window._pickState.regular === window._pickState.darkhorse) {
    document.getElementById('pick-validation').textContent = 'Regular and darkhorse picks must be different players.';
  } else {
    document.getElementById('pick-validation').textContent = '';
  }
}

function setDarkSide(mode) {
  window._pickState.isShutout = (mode === 'shutout');
  window._pickState.darkhorse = '';
  document.getElementById('dh-opt').classList.toggle('active', mode === 'darkhorse');
  document.getElementById('dh-opt').classList.remove('active-shutout');
  document.getElementById('so-opt').classList.toggle('active-shutout', mode === 'shutout');
  document.getElementById('so-opt').classList.toggle('active', false);
  document.getElementById('darkhorse-section').classList.toggle('hidden', mode === 'shutout');
  document.getElementById('shutout-section').classList.toggle('hidden', mode !== 'shutout');
  if (mode === 'darkhorse') document.getElementById('dh-opt').classList.add('active');
}

function setPlayType(pt, btn) {
  window._pickState.playType = pt;
  document.querySelectorAll('#play-type-group .toggle-item').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}
function setDhPlayType(pt, btn) {
  window._pickState.dhPlayType = pt;
  document.querySelectorAll('#dh-play-type-group .toggle-item').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

async function submitPick(existingId) {
  const ps = window._pickState;
  const err = document.getElementById('pick-validation');
  const btn = document.getElementById('submit-pick-btn');

  if (!ps.regular.trim()) { err.textContent = 'Select your regular pick.'; return; }
  if (!ps.isShutout && !ps.darkhorse.trim()) { err.textContent = 'Select a darkhorse pick or call a shutout.'; return; }
  if (!ps.isShutout && ps.regular === ps.darkhorse) { err.textContent = 'Regular and darkhorse picks must be different.'; return; }

  const ineligibleRaw = await DB.getIneligible(S.league?.id);
  if (!ps.isShutout && ineligibleRaw.map(i=>i.playerName).includes(ps.darkhorse)) {
    err.textContent = 'That player is darkhorse-ineligible this season.'; return;
  }
  const game = await DB.getGame(ps.gameId);
  if (!game || Date.now() >= new Date(game.deadline).getTime()) {
    err.textContent = 'Picks are locked for this game.'; return;
  }

  if (btn) { btn.disabled = true; btn.textContent = 'Saving‚Ä¶'; }
  const pickData = {
    userId: S.user.id, gameId: ps.gameId, leagueId: S.league?.id,
    regular: ps.regular, darkhorse: ps.isShutout ? null : ps.darkhorse,
    isShutout: ps.isShutout, playType: ps.playType, dhPlayType: ps.isShutout ? 'es' : (ps.dhPlayType || 'es'), scored: false,
  };
  try {
    if (existingId) { await DB.updatePick(existingId, pickData); toast('Pick updated!', 'ok'); }
    else            { await DB.createPick(pickData); toast('Pick locked in! üéØ', 'ok'); }
    route('pick-entry', {gameId: ps.gameId});
  } catch(e) {
    err.textContent = e.message || 'Could not save pick. Try again.';
    if (btn) { btn.disabled = false; btn.textContent = existingId ? 'Update Pick' : 'Lock In My Pick'; }
  }
}

function startEditPick(gameId) {
  S.params = {gameId, editing: true};
  render().catch(err => { console.error(err); toast('Something went wrong.', 'err'); });
}

async function confirmDeletePick(pickId, gameId) {
  openModal(`
    <div class="text-center">
      <div style="font-size:2.5rem;margin-bottom:12px">üóë</div>
      <div class="text-md mb-8">Delete your pick?</div>
      <div class="text-xs text-muted mb-20">You can submit a new pick before the deadline.</div>
      <div class="flex gap-8 justify-center">
        <button class="btn btn-ghost" onclick="closeModal()">Cancel</button>
        <button class="btn btn-primary" style="background:var(--err);border-color:var(--err)" onclick="doDeletePick('${pickId}','${gameId}')">Delete</button>
      </div>
    </div>`, 'Delete Pick');
}

async function doDeletePick(pickId, gameId) {
  closeModal();
  await DB.deletePick(pickId);
  toast('Pick deleted.', 'ok');
  route('pick-entry', {gameId});
}

function prefillPickForm(pick) {
  window._pickState = {
    gameId: pick.gameId, regular: pick.regular,
    darkhorse: pick.darkhorse||'', isShutout: pick.isShutout,
    playType: pick.playType, dhPlayType: pick.dhPlayType||'es',
  };
  const ri = document.getElementById('regular-input');
  const di = document.getElementById('darkhorse-input');
  if (ri) ri.value = pick.regular;
  if (!pick.isShutout && di) di.value = pick.darkhorse||'';
  if (pick.isShutout) setDarkSide('shutout');
  const ptMap = {es:0, pp:1, pk:2};
  const ptBtns = document.querySelectorAll('#play-type-group .toggle-item');
  ptBtns.forEach(b => b.classList.remove('active'));
  if (ptBtns[ptMap[pick.playType]]) ptBtns[ptMap[pick.playType]].classList.add('active');
  const dhBtns = document.querySelectorAll('#dh-play-type-group .toggle-item');
  dhBtns.forEach(b => b.classList.remove('active'));
  if (dhBtns[ptMap[pick.dhPlayType||'es']]) dhBtns[ptMap[pick.dhPlayType||'es']].classList.add('active');
  const sbtn = document.getElementById('submit-pick-btn');
  if (sbtn) { sbtn.textContent = 'Update Pick'; sbtn.onclick = () => submitPick(pick.id); }
}

// ==================== VIEW: PICKS LIST ======================
async function renderPicksList() {
  const league = S.league;
  if (!league) { route('league-select'); return; }
  const now = Date.now();
  const season = await DB.activeSeason(league.id);
  const allGames = season ? await DB.leagueGames(league.id, season.id) : [];
  const upcomingGames = allGames.filter(g => g.status !== 'completed').sort((a,b) => new Date(a.puckDrop)-new Date(b.puckDrop));
  const myPicks = await DB.userPicks(S.user.id, league.id);
  const team = TEAMS[S.user.teamId];

  document.getElementById('app').innerHTML = `
  ${renderHeader()}
  <div class="page page-enter" style="padding-top:12px">
    <div class="text-xl mb-16">My Picks</div>

    ${!season
      ? `<div class="empty">
          <div class="empty-icon">‚è∏Ô∏è</div>
          <div class="empty-title">No active season</div>
          ${S.isAdmin
            ? `<div class="empty-sub">You're the admin ‚Äî start a season first.</div>
               <button class="btn btn-primary mt-16" onclick="route('admin',{adminTab:'season'})">Admin ‚Üí Start Season</button>`
            : '<div class="empty-sub">An admin needs to start the season.</div>'}
        </div>`
      : upcomingGames.length === 0
      ? `<div class="empty">
          <div class="empty-icon">üèí</div>
          <div class="empty-title">No games scheduled yet</div>
          ${S.isAdmin
            ? `<div class="empty-sub">You're the league admin. Add games and your members can start picking!</div>
               <button class="btn btn-primary mt-16" onclick="route('admin',{adminTab:'games'})">Admin ‚Üí Add Games</button>`
            : '<div class="empty-sub">Check back when the admin schedules games.</div>'}
        </div>`
      :
    upcomingGames.map(g => {
      const myPick = myPicks.find(p => p.gameId === g.id) || null;
      const locked = g.status === 'locked' || now >= new Date(g.deadline).getTime();
      const result = null; // loaded on-demand via pick-entry view
      return `
      <div class="game-card mb-12" onclick="route('pick-entry',{gameId:'${g.id}'})" style="cursor:pointer">
        <div class="game-card-header">
          <div>
            <div class="game-vs">vs ${esc(g.opponent)}</div>
            <div class="game-time">${fmtDateTime(g.puckDrop)}</div>
          </div>
          ${result ? '<span class="pill pill-ok">Result Posted</span>'
            : locked ? '<span class="pill pill-gray">' + ico('lock') + ' Locked</span>'
            : myPick ? '<span class="pill pill-ok">‚úì Submitted</span>'
            : '<span class="pill pill-warn">Pick Now</span>'}
        </div>
        ${myPick ? `<div class="game-card-body">
          ${renderPickSummarySmall(myPick)}
          ${myPick.pts != null ? `<div class="flex items-center justify-between mt-12">
            <span class="text-xs text-muted">Score</span>
            <div class="score-badge" style="font-size:1.2rem;${myPick.pts>0?'color:var(--ok)':'color:var(--t2)'}">${myPick.pts}<span>pts</span></div>
          </div>` : ''}
        </div>` : locked ? `<div class="game-card-body">
          <div class="empty" style="padding:16px 0"><div class="empty-icon" style="font-size:1.5rem">${ico('lock')}</div>
          <div class="empty-title" style="font-size:0.85rem">No pick submitted</div></div>
        </div>` : `<div class="game-card-body">
          <button class="btn btn-primary btn-block" onclick="event.stopPropagation();route('pick-entry',{gameId:'${g.id}'})">Make Pick ‚Üí</button>
        </div>`}
      </div>`;
    }).join('')}
  </div>
  ${renderNav('picks')}`;
}

// ==================== VIEW: STANDINGS =======================
async function renderStandings() {
  const league = S.league;
  if (!league) { route('league-select'); return; }
  const [seasons, activeSeason] = await Promise.all([DB.getLeagueSeasons(league.id), DB.activeSeason(league.id)]);
  const displaySeason = activeSeason || seasons[seasons.length-1];
  const lb = displaySeason ? await computeLeaderboard(league.id, displaySeason.id) : [];
  const top3 = lb.slice(0,3);
  const myIdx = lb.findIndex(e => e.userId === S.user.id);
  const myEntry = lb[myIdx];

  document.getElementById('app').innerHTML = `
  ${renderHeader()}
  <div class="page page-enter" style="padding-top:12px">
    <div class="flex items-center justify-between mb-8">
      <div class="text-xl">Standings</div>
      ${seasons.length > 1 ? `<select class="form-input form-select" style="width:auto;height:36px;font-size:0.8rem" onchange="changeSeason(this.value)">
        ${seasons.map(s => `<option value="${s.id}" ${displaySeason?.id===s.id?'selected':''}>${esc(s.name)}</option>`).join('')}
      </select>` : ''}
    </div>

    ${displaySeason ? `<div class="text-xs text-muted mb-16">${esc(displaySeason.name)} ¬∑ ${esc(league.name)}</div>` : ''}

    ${lb.length === 0 ? '<div class="empty"><div class="empty-icon">üèÜ</div><div class="empty-title">No results yet</div><div class="empty-sub">Standings will appear once games are scored</div></div>' : `

    ${top3.length >= 1 ? `
    <div class="podium">
      ${top3.length >= 2 ? `<div class="podium-item podium-2">
        <div class="podium-block"><div>ü•à</div><div style="font-size:0.95rem">${top3[1].pts}</div></div>
        <div class="avatar avatar-sm">${initials(top3[1].username)}</div>
        <div class="podium-name">${esc(top3[1].username)}</div>
      </div>` : '<div class="podium-item"></div>'}
      <div class="podium-item podium-1">
        <div class="podium-block"><div>ü•á</div><div>${top3[0].pts}</div></div>
        <div class="avatar">${initials(top3[0].username)}</div>
        <div class="podium-name">${esc(top3[0].username)}</div>
      </div>
      ${top3.length >= 3 ? `<div class="podium-item podium-3">
        <div class="podium-block"><div>ü•â</div><div style="font-size:0.9rem">${top3[2].pts}</div></div>
        <div class="avatar avatar-sm">${initials(top3[2].username)}</div>
        <div class="podium-name">${esc(top3[2].username)}</div>
      </div>` : '<div class="podium-item"></div>'}
    </div>` : ''}

    <div class="card">
      ${lb.map((e,i) => {
        const isMe = e.userId === S.user.id;
        const medal = ['gold','silver','bronze'][i] || '';
        return `<div class="stat-row ${isMe ? 'card-glow' : ''}" style="${isMe?'border-radius:var(--r-sm);padding:10px 8px;margin:2px 0':''}">
          <div class="stat-rank ${medal}">${medal==='gold'?'ü•á':medal==='silver'?'ü•à':medal==='bronze'?'ü•â':(i+1)}</div>
          <div class="avatar avatar-sm">${initials(e.username)}</div>
          <div class="stat-info">
            <div class="stat-name">${esc(e.username)}${isMe?' <span style="font-size:0.65rem;color:var(--tp)">(you)</span>':''}</div>
            <div class="stat-sub">${e.played} games ¬∑ ${e.shutouts}ü•Ö ¬∑ ${e.darkhorses}üéØ</div>
          </div>
          <div class="stat-pts">${e.pts}<span class="text-xs text-muted"> pts</span></div>
        </div>`;
      }).join('')}
    </div>

    ${myIdx >= 3 ? `<div class="card mt-8" style="border-color:var(--tp)">
      <div class="stat-row">
        <div class="stat-rank" style="color:var(--tp)">${myIdx+1}</div>
        <div class="avatar avatar-sm">${initials(myEntry.username)}</div>
        <div class="stat-info">
          <div class="stat-name">You</div>
          <div class="stat-sub">${myEntry.played} games ¬∑ ${myEntry.shutouts}ü•Ö ¬∑ ${myEntry.darkhorses}üéØ</div>
        </div>
        <div class="stat-pts">${myEntry.pts}<span class="text-xs text-muted"> pts</span></div>
      </div>
    </div>` : ''}

    <div class="card mt-12" style="padding:12px">
      <div class="text-xs text-muted fw-bold mb-8">Tiebreaker order:</div>
      <div class="text-xs text-muted">1. Most shutouts correctly called</div>
      <div class="text-xs text-muted">2. Most darkhorse correct picks</div>
      <div class="text-xs text-muted">3. Most games participated</div>
    </div>`}
  </div>
  ${renderNav('standings')}`;
}

window.changeSeason = function(seasonId) { route('standings'); };

// ==================== VIEW: HISTORY =========================
async function renderHistory() {
  const league = S.league;
  if (!league) { route('league-select'); return; }
  const [allGamesRaw, myPicks] = await Promise.all([
    DB.leagueGames(league.id),
    DB.userPicks(S.user.id, league.id),
  ]);
  const allGames = allGamesRaw.filter(g => g.status === 'completed')
    .sort((a,b) => new Date(b.puckDrop) - new Date(a.puckDrop));

  document.getElementById('app').innerHTML = `
  ${renderHeader()}
  <div class="page page-enter" style="padding-top:12px">
    <div class="text-xl mb-16">History</div>

    ${allGames.length === 0 ? '<div class="empty"><div class="empty-icon">üìã</div><div class="empty-title">No completed games yet</div></div>' :
    allGames.map(g => {
      const myPick = myPicks.find(p => p.gameId === g.id) || null;
      const result = null; // loaded on-demand when user opens pick-entry
      return `
      <div class="history-item" onclick="route('pick-entry',{gameId:'${g.id}'})" style="cursor:pointer">
        <div class="history-header">
          <div>
            <div class="text-sm fw-bold">vs ${esc(g.opponent)}</div>
            <div class="text-xs text-muted">${fmtDate(g.puckDrop)}</div>
          </div>
          <div class="flex items-center gap-8">
            ${result?.isShutout ? '<span class="pill pill-blue">ü•Ö Shutout</span>' : ''}
            ${myPick?.pts != null
              ? `<div class="score-badge" style="font-size:1.1rem;${myPick.pts>0?'color:var(--ok)':'color:var(--t2)'}">${myPick.pts}<span>pts</span></div>`
              : myPick ? '<span class="pill pill-gray">Pending</span>'
              : '<span class="pill pill-err">No pick</span>'}
          </div>
        </div>
        ${myPick ? `<div class="history-body">
          <div class="flex gap-8" style="flex-wrap:wrap">
            <span class="text-xs text-muted">Regular: <strong>${esc(myPick.regular)}</strong></span>
            <span class="text-xs text-muted">¬∑</span>
            <span class="text-xs text-muted">${myPick.isShutout ? 'Shutout call' : `DH: <strong>${esc(myPick.darkhorse)}</strong>`}</span>
            <span class="text-xs text-muted">¬∑</span>
            <span class="text-xs text-muted">${playTypeShort(myPick.playType)}</span>
          </div>
          ${result && !result.isShutout ? `<div class="text-xs text-muted mt-4">First goal: <strong>${esc(result.firstScorer)}</strong> (${playTypeShort(result.firstPlayType)})</div>` : ''}
        </div>` : '<div class="history-body"><div class="text-xs text-muted">No pick submitted for this game</div></div>'}
      </div>`;
    }).join('')}
  </div>
  ${renderNav('history')}`;
}

// ==================== VIEW: NOTIFICATIONS ===================
async function renderNotifications() {
  const notifs = await DB.userNotifs(S.user.id);
  await DB.markAllRead(S.user.id);

  document.getElementById('app').innerHTML = `
  ${renderHeader('Notifications')}
  <div class="page page-enter" style="padding-top:12px">
    ${notifs.length === 0
      ? '<div class="empty"><div class="empty-icon">üîî</div><div class="empty-title">No notifications yet</div></div>'
      : notifs.map(n => `
      <div class="notif-item">
        <div class="notif-dot ${n.read?'read':''}"></div>
        <div>
          <div class="notif-msg">${esc(n.message)}</div>
          <div class="notif-time">${fmtDateTime(n.createdAt)}</div>
        </div>
      </div>`).join('')}
  </div>
  ${renderNav('dashboard')}`;
}

// ==================== VIEW: PROFILE =========================
async function renderProfile() {
  const user = S.user;
  const team = TEAMS[user.teamId];
  const userLeagues = S.userLeagues;

  document.getElementById('app').innerHTML = `
  ${renderHeader('Profile')}
  <div class="page page-enter" style="padding-top:12px">
    <div class="card text-center mb-16" style="padding:24px">
      <div class="avatar avatar-lg" style="margin:0 auto 12px">${initials(user.username)}</div>
      <div class="text-xl">${esc(user.username)}</div>
      <div class="text-sm text-muted mt-4">${esc(user.email)}</div>
      ${team ? `<div class="pill pill-blue mt-12">${team.e} ${esc(team.name)}</div>` : ''}
    </div>

    <div class="section-label">Your Leagues</div>
    ${userLeagues.map(l => {
      const t = TEAMS[l.teamId];
      const isAdmin = l.myRole === 'admin';
      return `<div class="card card-sm mb-8 card-clickable" onclick="switchLeague('${l.id}')">
        <div class="flex items-center gap-12">
          <span style="font-size:1.5rem">${t?.e||'üèí'}</span>
          <div class="flex-1">
            <div class="text-sm">${esc(l.name)}</div>
            <div class="text-xs text-muted">${esc(t?.name||'')}</div>
          </div>
          ${isAdmin ? '<span class="pill pill-gold">Admin</span>' : ''}
          ${S.league?.id === l.id ? '<span class="pill pill-ok">Active</span>' : ''}
        </div>
      </div>`;
    }).join('')}
    <button class="btn btn-ghost btn-sm mb-16" onclick="route('league-select')">${ico('plus')} Join or Create League</button>

    <div class="section-label">Change Team</div>
    <div class="card card-sm card-clickable mb-16" onclick="route('team-select')">
      <div class="flex items-center gap-12">
        ${team ? `<span style="font-size:1.5rem">${team.e}</span>` : ''}
        <div class="flex-1">
          <div class="text-sm">${team ? esc(team.name) : 'No team selected'}</div>
          <div class="text-xs text-muted">Tap to change</div>
        </div>
        ${ico('edit')}
      </div>
    </div>

    <div class="section-label">Change Password</div>
    <div class="card mb-16">
      <div class="form-group">
        <label class="form-label">New Password</label>
        <input class="form-input" id="new-pw" type="password" placeholder="New password" minlength="6">
      </div>
      <div id="pw-err" class="form-error mb-8"></div>
      <button class="btn btn-secondary" onclick="changePassword()">Update Password</button>
    </div>

    <button class="btn btn-danger btn-block" onclick="Auth.logout()">Sign Out</button>

    <div class="text-center text-xs text-dim mt-16">FGOTG v1.0 ¬∑ Built for hockey fans</div>
  </div>
  ${renderNav('profile')}`;
}

async function changePassword() {
  const pw = document.getElementById('new-pw').value;
  if (pw.length < 6) { document.getElementById('pw-err').textContent = 'Minimum 6 characters'; return; }
  const {error} = await sb.auth.updateUser({password: pw});
  if (error) { document.getElementById('pw-err').textContent = error.message; return; }
  document.getElementById('new-pw').value = '';
  document.getElementById('pw-err').textContent = '';
  toast('Password updated', 'ok');
}

// ==================== VIEW: ADMIN ===========================
async function renderAdmin() {
  if (!S.league || !S.isAdmin) { toast('Admin access required', 'err'); route('dashboard'); return; }
  const league = S.league;
  const adminTab = S.params.adminTab || 'games';

  const [season, members] = await Promise.all([
    DB.activeSeason(league.id),
    DB.getLeagueMembers(league.id),
  ]);

  let content = '';
  if (adminTab === 'games')   content = await renderAdminGames(league, season);
  else if (adminTab === 'results') content = await renderAdminResults(league, season);
  else if (adminTab === 'players') content = await renderAdminPlayers(league);
  else if (adminTab === 'season')  content = await renderAdminSeason(league, season, members);

  document.getElementById('app').innerHTML = `
  ${renderHeader('Admin Panel')}
  <div class="page page-enter" style="padding-top:12px">
    <div class="admin-tabs">
      <button class="admin-tab ${adminTab==='games'?'active':''}" onclick="setAdminTab('games')">Games</button>
      <button class="admin-tab ${adminTab==='results'?'active':''}" onclick="setAdminTab('results')">Results</button>
      <button class="admin-tab ${adminTab==='players'?'active':''}" onclick="setAdminTab('players')">Roster</button>
      <button class="admin-tab ${adminTab==='season'?'active':''}" onclick="setAdminTab('season')">Season</button>
    </div>
    <div id="admin-content">${content}</div>
  </div>
  ${renderNav('admin')}`;
}

function setAdminTab(tab) { S.params.adminTab = tab; renderAdmin(); }

// --- Admin: Games ---
async function renderAdminGames(league, season) {
  const games = season ? await DB.leagueGames(league.id, season.id) : [];
  const team = TEAMS[league.teamId];
  const now = Date.now();
  const pickCounts = {}, results = {};
  if (games.length > 0) {
    const [picksArr, resArr] = await Promise.all([
      Promise.all(games.map(g => DB.gamePicks(g.id))),
      Promise.all(games.map(g => DB.getResult(g.id))),
    ]);
    games.forEach((g, i) => { pickCounts[g.id] = picksArr[i]?.length || 0; results[g.id] = resArr[i]; });
  }

  return `
  <div>
    ${!season ? `<div class="card" style="background:rgba(245,158,11,0.08);border-color:rgba(245,158,11,0.3);margin-bottom:12px">
      <div class="text-sm">‚ö†Ô∏è Start a season first in the Season tab before adding games.</div>
    </div>` : ''}

    <div class="flex items-center justify-between mb-8">
      <div class="text-md">Games Schedule</div>
      ${season ? `<div class="flex gap-8">
        <button class="btn btn-secondary btn-sm" onclick="importNHLSchedule('${league.id}','${season.id}','${league.teamId}')">
          üìÖ Import NHL
        </button>
        <button class="btn btn-primary btn-sm" onclick="openAddGameModal('${league.id}','${season.id}')">
          ${ico('plus')} Add
        </button>
      </div>` : ''}
    </div>
    ${season ? `<div class="text-xs text-muted mb-12" style="color:var(--t2)">Import pulls the full NHL schedule for your team automatically.</div>` : ''}

    ${games.length === 0
      ? '<div class="empty"><div class="empty-icon">üìÖ</div><div class="empty-title">No games yet</div><div class="empty-sub">Import from the NHL schedule or add manually</div></div>'
      : games.map(g => {
          const pc = pickCounts[g.id];
          const result = results[g.id];
          const isLocked = now >= new Date(g.deadline).getTime();
          return `
          <div class="card card-sm mb-8">
            <div class="flex items-center justify-between mb-4">
              <div>
                <div class="text-sm fw-bold">${esc(team?.abbr||'')} vs ${esc(g.opponent)}</div>
                <div class="text-xs text-muted">${fmtDateTime(g.puckDrop)}</div>
                <div class="text-xs text-muted">Deadline: ${fmtDateTime(g.deadline)} ¬∑ ${pc} pick${pc!==1?'s':''}</div>
              </div>
              <div class="flex flex-col gap-4" style="align-items:flex-end">
                ${g.status === 'completed'
                  ? '<span class="pill pill-ok">Completed</span>'
                  : isLocked
                    ? '<span class="pill pill-warn">Locked</span>'
                    : '<span class="pill pill-blue">Open</span>'}
                <div class="flex gap-4 mt-4">
                  <button class="btn btn-ghost btn-sm" onclick="openEditGameModal('${g.id}')">${ico('edit')}</button>
                  ${g.status !== 'completed' ? `<button class="btn btn-ghost btn-sm" onclick="deleteGame('${g.id}')" style="color:var(--err)">${ico('trash')}</button>` : ''}
                </div>
              </div>
            </div>
            ${result ? `<div class="text-xs text-dim">Result: ${result.isShutout ? 'ü•Ö Shutout' : `${esc(result.firstScorer)} (${playTypeShort(result.firstPlayType)})`}</div>` : ''}
          </div>`;
        }).join('')}
  </div>`;
}

function openAddGameModal(leagueId, seasonId) {
  const now = new Date();
  const defPuck = new Date(now.getTime() + 86400000);
  const defDeadline = new Date(defPuck.getTime() - 3600000);
  const fmt = d => d.toISOString().slice(0,16);

  openModal(`
  <form onsubmit="handleAddGame(event,'${leagueId}','${seasonId}')">
    <div class="form-group">
      <label class="form-label">Opponent</label>
      <input class="form-input" id="ag-opp" placeholder="e.g. Boston Bruins" required>
    </div>
    <div class="form-group">
      <label class="form-label">Home / Away</label>
      <select class="form-input form-select" id="ag-ha">
        <option value="home">Home</option>
        <option value="away">Away</option>
      </select>
    </div>
    <div class="form-group">
      <label class="form-label">Puck Drop</label>
      <input class="form-input" id="ag-puck" type="datetime-local" value="${fmt(defPuck)}" required>
    </div>
    <div class="form-group">
      <label class="form-label">Pick Deadline</label>
      <input class="form-input" id="ag-deadline" type="datetime-local" value="${fmt(defDeadline)}" required>
    </div>
    <button type="submit" class="btn btn-primary btn-block mt-8">Add Game</button>
  </form>`, 'Add Game');
}

async function handleAddGame(e, leagueId, seasonId) {
  e.preventDefault();
  const btn = e.target.querySelector('[type=submit]');
  btn.disabled = true; btn.textContent = 'Adding‚Ä¶';
  const opp = document.getElementById('ag-opp').value.trim();
  const ha = document.getElementById('ag-ha').value;
  const puck = new Date(document.getElementById('ag-puck').value).toISOString();
  const deadline = new Date(document.getElementById('ag-deadline').value).toISOString();
  if (!opp) { btn.disabled = false; btn.textContent = 'Add Game'; return; }
  if (new Date(deadline) >= new Date(puck)) { toast('Deadline must be before puck drop', 'err'); btn.disabled = false; btn.textContent = 'Add Game'; return; }
  await DB.createGame({ leagueId, seasonId, opponent: opp, homeAway: ha, puckDrop: puck, deadline, status: 'upcoming' });
  await DB.broadcastNotif(leagueId, `New game added: vs ${opp} on ${fmtDate(puck)}. Submit your picks!`, 'pick_due');
  toast('Game added!', 'ok');
  closeModal();
  setAdminTab('games');
}

async function openEditGameModal(gameId) {
  const g = await DB.getGame(gameId);
  if (!g) return;
  const fmt = ts => new Date(ts).toISOString().slice(0,16);
  openModal(`
  <form onsubmit="handleEditGame(event,'${gameId}')">
    <div class="form-group">
      <label class="form-label">Opponent</label>
      <input class="form-input" id="eg-opp" value="${esc(g.opponent)}" required>
    </div>
    <div class="form-group">
      <label class="form-label">Puck Drop</label>
      <input class="form-input" id="eg-puck" type="datetime-local" value="${fmt(g.puckDrop)}" required>
    </div>
    <div class="form-group">
      <label class="form-label">Pick Deadline</label>
      <input class="form-input" id="eg-deadline" type="datetime-local" value="${fmt(g.deadline)}" required>
    </div>
    <div class="form-group">
      <label class="form-label">Status</label>
      <select class="form-input form-select" id="eg-status">
        <option value="upcoming" ${g.status==='upcoming'?'selected':''}>Upcoming</option>
        <option value="locked" ${g.status==='locked'?'selected':''}>Locked</option>
        <option value="completed" ${g.status==='completed'?'selected':''}>Completed</option>
      </select>
    </div>
    <button type="submit" class="btn btn-primary btn-block mt-8">Save Changes</button>
  </form>`, 'Edit Game');
}

async function handleEditGame(e, gameId) {
  e.preventDefault();
  const btn = e.target.querySelector('[type=submit]');
  btn.disabled = true; btn.textContent = 'Saving‚Ä¶';
  const opp = document.getElementById('eg-opp').value.trim();
  const puck = new Date(document.getElementById('eg-puck').value).toISOString();
  const deadline = new Date(document.getElementById('eg-deadline').value).toISOString();
  const status = document.getElementById('eg-status').value;
  await DB.updateGame(gameId, {opponent:opp, puckDrop:puck, deadline, status});
  toast('Game updated', 'ok');
  closeModal();
  setAdminTab('games');
}

async function deleteGame(gameId) {
  if (!confirm('Delete this game and all related picks?')) return;
  await DB.deleteGame(gameId);
  toast('Game deleted', 'ok');
  setAdminTab('games');
}

// --- NHL Schedule Import ---
async function importNHLSchedule(leagueId, seasonId, teamAbbr) {
  openModal(`
    <div class="text-center" style="padding:32px 0">
      <div style="font-size:2rem;margin-bottom:12px">üì°</div>
      <div class="text-md">Fetching NHL schedule‚Ä¶</div>
      <div class="text-xs text-muted mt-8">Connecting to NHL API</div>
    </div>
  `, 'Import NHL Schedule');

  try {
    // NHL public API ‚Äî no auth needed, CORS open
    const url = `https://api-web.nhle.com/v1/club-schedule-season/${teamAbbr}/now`;
    const res = await fetch(url);
    if (!res.ok) throw new Error(`NHL API returned ${res.status}`);
    const data = await res.json();

    const games = data.games || [];
    const now = Date.now();

    // Get already-imported game dates so we don't double-import
    const existingGames = await DB.leagueGames(leagueId, seasonId);
    const existingDates = new Set(existingGames.map(g => new Date(g.puckDrop).toISOString().slice(0, 10)));

    // Filter: future regular season / playoff games only
    const upcoming = games.filter(g => {
      const ts = new Date(g.startTimeUTC).getTime();
      const date = new Date(g.startTimeUTC).toISOString().slice(0, 10);
      return (g.gameType === 2 || g.gameType === 3)
        && ts > now
        && !existingDates.has(date);
    });

    if (upcoming.length === 0) {
      document.getElementById('modal-content').innerHTML = `
        <div class="modal-title">Import NHL Schedule</div>
        <div class="empty">
          <div class="empty-icon">‚úÖ</div>
          <div class="empty-title">All caught up!</div>
          <div class="empty-sub">No new upcoming games found for ${teamAbbr}. All future games are already imported, or the season hasn't started yet.</div>
        </div>
        <button class="btn btn-secondary btn-block mt-16" onclick="closeModal()">Close</button>`;
      return;
    }

    // Build import modal UI
    const team = TEAMS[teamAbbr];
    const rows = upcoming.map(g => {
      const puckDrop = new Date(g.startTimeUTC).getTime();
      const isHome = g.homeTeam.abbrev === teamAbbr;
      const opp = isHome ? g.awayTeam : g.homeTeam;
      const oppAbbr = opp.abbrev || '';
      // Prefer local TEAMS lookup, fall back to API placeName+commonName, then abbrev
      const oppName = TEAMS[oppAbbr]?.name
        || [opp.placeName?.default, opp.commonName?.default].filter(Boolean).join(' ')
        || oppAbbr
        || 'Unknown';
      const ha = isHome ? 'vs' : '@';
      const oppTeam = TEAMS[oppAbbr];
      // Default deadline: 30 min before puck drop
      const defDeadline = puckDrop - 30 * 60 * 1000;
      return { puckDrop, oppName, oppAbbr, ha, isHome, defDeadline, gameType: g.gameType };
    });

    // Store for use by confirm handler
    window._nhlImportRows = rows;
    window._nhlImportLeagueId = leagueId;
    window._nhlImportSeasonId = seasonId;

    const rowsHtml = rows.map((r, i) => {
      const typeLabel = r.gameType === 3 ? ' üèÜ' : '';
      return `
      <label class="admin-action-row" style="cursor:pointer">
        <div class="flex items-center gap-8" style="flex:1">
          <input type="checkbox" class="nhl-game-cb" data-idx="${i}" checked
            style="width:18px;height:18px;accent-color:var(--tp);flex-shrink:0">
          <div>
            <div class="text-sm fw-bold">${r.ha} ${esc(r.oppName)}${typeLabel}</div>
            <div class="text-xs text-muted">${fmtDateTime(r.puckDrop)}</div>
          </div>
        </div>
        <span class="pill ${r.isHome ? 'pill-blue' : 'pill-gray'}" style="font-size:0.62rem">
          ${r.isHome ? 'HOME' : 'AWAY'}
        </span>
      </label>`;
    }).join('');

    document.getElementById('modal-content').innerHTML = `
      <div class="modal-title">Import NHL Schedule</div>
      <div class="flex items-center justify-between mb-8">
        <div class="text-sm">${upcoming.length} upcoming game${upcoming.length !== 1 ? 's' : ''} found</div>
        <div class="flex gap-8">
          <button class="btn btn-ghost btn-sm" onclick="document.querySelectorAll('.nhl-game-cb').forEach(c=>c.checked=true)">All</button>
          <button class="btn btn-ghost btn-sm" onclick="document.querySelectorAll('.nhl-game-cb').forEach(c=>c.checked=false)">None</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">Default pick deadline</label>
        <select class="form-input form-select" id="nhl-deadline-offset">
          <option value="1800">30 min before puck drop</option>
          <option value="3600" selected>1 hour before puck drop</option>
          <option value="7200">2 hours before puck drop</option>
          <option value="10800">3 hours before puck drop</option>
          <option value="86400">Day before (noon)</option>
        </select>
      </div>
      <div style="max-height:340px;overflow-y:auto;border:1px solid var(--bdr);border-radius:var(--r-sm);padding:4px 8px;margin-bottom:16px">
        ${rowsHtml}
      </div>
      <button class="btn btn-primary btn-block" onclick="confirmNHLImport()">
        Import Selected Games
      </button>`;

  } catch (err) {
    document.getElementById('modal-content').innerHTML = `
      <div class="modal-title">Import Failed</div>
      <div class="card" style="background:rgba(239,68,68,0.08);border-color:rgba(239,68,68,0.3);margin-bottom:16px">
        <div class="text-sm text-err fw-bold mb-4">Could not reach the NHL API</div>
        <div class="text-xs text-muted">${esc(err.message)}</div>
        <div class="text-xs text-muted mt-8">This can happen when: the API is temporarily down, or your browser blocks the request. Try again or add games manually.</div>
      </div>
      <button class="btn btn-secondary btn-block" onclick="closeModal()">Close</button>
      <button class="btn btn-primary btn-block mt-8" onclick="openAddGameModal('${window._nhlImportLeagueId}','${window._nhlImportSeasonId}');closeModal()">Add Manually Instead</button>`;
  }
}

async function confirmNHLImport() {
  const rows = window._nhlImportRows || [];
  const leagueId = window._nhlImportLeagueId;
  const seasonId = window._nhlImportSeasonId;
  const offsetSecs = parseInt(document.getElementById('nhl-deadline-offset')?.value || '3600');
  const offsetMs = offsetSecs * 1000;

  const selected = [...document.querySelectorAll('.nhl-game-cb')]
    .filter(cb => cb.checked)
    .map(cb => rows[parseInt(cb.dataset.idx)])
    .filter(Boolean);

  if (selected.length === 0) { toast('Select at least one game', 'err'); return; }

  const importBtn = document.querySelector('[onclick="confirmNHLImport()"]');
  if (importBtn) { importBtn.disabled = true; importBtn.textContent = 'Importing‚Ä¶'; }

  // Deduplicate against already-stored games by date
  const existingGames = await DB.leagueGames(leagueId, seasonId);
  const existingDates = new Set(existingGames.map(g => new Date(g.puckDrop).toISOString().slice(0, 10)));

  let added = 0;
  for (const r of selected) {
    const date = new Date(r.puckDrop).toISOString().slice(0, 10);
    if (existingDates.has(date)) continue;
    await DB.createGame({
      leagueId, seasonId,
      opponent: r.oppName,
      homeAway: r.isHome ? 'home' : 'away',
      puckDrop: new Date(r.puckDrop).toISOString(),
      deadline: new Date(r.puckDrop - offsetMs).toISOString(),
      status: 'upcoming',
    });
    existingDates.add(date);
    added++;
  }

  if (added > 0) {
    await DB.broadcastNotif(leagueId,
      `üìÖ ${added} new game${added !== 1 ? 's' : ''} added to the schedule. Get your picks in!`,
      'pick_due');
  }

  closeModal();
  toast(`${added} game${added !== 1 ? 's' : ''} imported!`, 'ok');
  setAdminTab('games');
}

// --- Admin: Results ---
async function renderAdminResults(league, season) {
  const allGames = season ? await DB.leagueGames(league.id, season.id) : [];
  const now = Date.now();
  const games = allGames.filter(g => g.status !== 'upcoming' || now >= new Date(g.deadline).getTime());
  const [picksArr, resArr] = games.length > 0
    ? await Promise.all([
        Promise.all(games.map(g => DB.gamePicks(g.id))),
        Promise.all(games.map(g => DB.getResult(g.id))),
      ])
    : [[], []];
  const pickCounts = {}, resultMap = {};
  games.forEach((g, i) => { pickCounts[g.id] = picksArr[i]?.length || 0; resultMap[g.id] = resArr[i]; });

  const pendingResults = games.filter(g => !resultMap[g.id]);
  const completedGames = games.filter(g => resultMap[g.id]);

  return `
  <div>
    <div class="text-md mb-12">Enter Game Results</div>
    ${pendingResults.length === 0 && completedGames.length === 0
      ? '<div class="empty"><div class="empty-icon">üèí</div><div class="empty-title">No games ready for results</div><div class="empty-sub">Games must be past their deadline to enter results</div></div>'
      : ''}

    ${pendingResults.length > 0 ? `
    <div class="section-label">Awaiting Results (${pendingResults.length})</div>
    ${pendingResults.map(g => `
    <div class="card card-sm mb-8" style="border-color:var(--warn)">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-sm fw-bold">vs ${esc(g.opponent)}</div>
          <div class="text-xs text-muted">${fmtDate(g.puckDrop)} ¬∑ ${pickCounts[g.id]} picks</div>
        </div>
        <button class="btn btn-primary btn-sm" onclick="openResultModal('${g.id}')">Enter Result</button>
      </div>
    </div>`).join('')}` : ''}

    ${completedGames.length > 0 ? `
    <div class="section-label">Completed Games</div>
    ${completedGames.map(g => {
      const r = resultMap[g.id];
      return `
      <div class="card card-sm mb-8">
        <div class="flex items-center justify-between">
          <div>
            <div class="text-sm fw-bold">vs ${esc(g.opponent)}</div>
            <div class="text-xs text-muted">${r.isShutout ? 'ü•Ö Shutout' : `${esc(r.firstScorer)} ¬∑ ${playTypeShort(r.firstPlayType)}`}</div>
          </div>
          <button class="btn btn-ghost btn-sm" onclick="openResultModal('${g.id}')">Edit</button>
        </div>
      </div>`;
    }).join('')}` : ''}
  </div>`;
}

async function openResultModal(gameId) {
  const [g, existing, players] = await Promise.all([
    DB.getGame(gameId),
    DB.getResult(gameId),
    DB.getPlayers(S.league?.id),
  ]);
  const sortedPlayers = [...players].sort();
  const opts = sortedPlayers.map(p => `<option value="${esc(p)}" ${existing?.firstScorer===p?'selected':''}>${esc(p)}</option>`).join('');
  const opts2 = sortedPlayers.map(p => `<option value="${esc(p)}" ${existing?.secondScorer===p?'selected':''}>${esc(p)}</option>`).join('');

  openModal(`
  <form onsubmit="handleEnterResult(event,'${gameId}')">
    <div class="text-sm text-muted mb-12">vs ${esc(g?.opponent)} ‚Äî ${g ? fmtDate(g.puckDrop) : ''}</div>

    <div class="form-group">
      <label class="form-label">Result Type</label>
      <div class="toggle-group" id="res-type-group">
        <button type="button" class="toggle-item ${!existing?.isShutout?'active':''}" onclick="setResType('goal',this)">Goal Scored</button>
        <button type="button" class="toggle-item ${existing?.isShutout?'active':''}" onclick="setResType('shutout',this)">Shutout</button>
      </div>
    </div>

    <div id="goal-fields" style="${existing?.isShutout?'display:none':''}">
      <div class="form-group">
        <label class="form-label">First Goal Scorer</label>
        <select class="form-input form-select" id="res-scorer">
          <option value="">Select player...</option>
          ${opts}
        </select>
        <div class="form-hint">Or type a name not on the list</div>
        <input class="form-input mt-4" id="res-scorer-custom" placeholder="Custom name (leave blank if using list)" value="${existing && !sortedPlayers.includes(existing.firstScorer) && !existing.isShutout ? esc(existing.firstScorer) : ''}">
      </div>
      <div class="form-group">
        <label class="form-label">Play Type</label>
        <div class="toggle-group" id="res-pt-group">
          <button type="button" class="toggle-item ${existing?.firstPlayType==='es'||!existing?'active':''}" onclick="setResPlayType('es',this)">Even Str.</button>
          <button type="button" class="toggle-item ${existing?.firstPlayType==='pp'?'active':''}" onclick="setResPlayType('pp',this)">Power Play</button>
          <button type="button" class="toggle-item ${existing?.firstPlayType==='pk'?'active':''}" onclick="setResPlayType('pk',this)">Penalty Kill</button>
        </div>
      </div>
      <div class="form-group">
        <label class="form-label">2nd Goal Scorer (optional ‚Äî needed if a darkhorse scored first)</label>
        <select class="form-input form-select" id="res-scorer2">
          <option value="">None / Unknown</option>
          ${opts2}
        </select>
        <input class="form-input mt-4" id="res-scorer2-custom" placeholder="Custom name for 2nd goal" value="${existing?.secondScorer && !sortedPlayers.includes(existing.secondScorer) ? esc(existing.secondScorer) : ''}">
      </div>
      <div class="form-group">
        <label class="form-label">2nd Goal Play Type</label>
        <div class="toggle-group" id="res-pt2-group">
          <button type="button" class="toggle-item ${existing?.secondPlayType==='es'||!existing?.secondPlayType?'active':''}" onclick="setResPlayType2('es',this)">Even Str.</button>
          <button type="button" class="toggle-item ${existing?.secondPlayType==='pp'?'active':''}" onclick="setResPlayType2('pp',this)">Power Play</button>
          <button type="button" class="toggle-item ${existing?.secondPlayType==='pk'?'active':''}" onclick="setResPlayType2('pk',this)">Penalty Kill</button>
        </div>
      </div>
    </div>

    <div id="res-error" class="form-error mb-8"></div>
    <button type="submit" class="btn btn-primary btn-block">Save Result & Score Picks</button>
  </form>`, existing ? 'Edit Result' : 'Enter Result');

  window._resType = existing?.isShutout ? 'shutout' : 'goal';
  window._resPlayType = existing?.firstPlayType || 'es';
  window._resPlayType2 = existing?.secondPlayType || 'es';
}

window._resType = 'goal';
window._resPlayType = 'es';
window._resPlayType2 = 'es';

function setResType(type, btn) {
  window._resType = type;
  document.querySelectorAll('#res-type-group .toggle-item').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
  document.getElementById('goal-fields').style.display = type === 'goal' ? '' : 'none';
}
function setResPlayType(pt, btn) {
  window._resPlayType = pt;
  document.querySelectorAll('#res-pt-group .toggle-item').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}
function setResPlayType2(pt, btn) {
  window._resPlayType2 = pt;
  document.querySelectorAll('#res-pt2-group .toggle-item').forEach(b => b.classList.remove('active'));
  btn.classList.add('active');
}

async function handleEnterResult(e, gameId) {
  e.preventDefault();
  const btn = e.target.querySelector('[type=submit]');
  btn.disabled = true; btn.textContent = 'Saving‚Ä¶';

  const isShutout = window._resType === 'shutout';
  let firstScorer = null, firstPlayType = null, secondScorer = null, secondPlayType = null;

  if (!isShutout) {
    const custom = document.getElementById('res-scorer-custom').value.trim();
    const select = document.getElementById('res-scorer').value;
    firstScorer = custom || select;
    if (!firstScorer) {
      document.getElementById('res-error').textContent = 'Select or enter the first goal scorer.';
      btn.disabled = false; btn.textContent = 'Save Result & Score Picks';
      return;
    }
    firstPlayType = window._resPlayType;
    const custom2 = document.getElementById('res-scorer2-custom').value.trim();
    const select2 = document.getElementById('res-scorer2').value;
    secondScorer = custom2 || select2 || null;
    secondPlayType = secondScorer ? window._resPlayType2 : null;
  }

  await DB.saveResult({ gameId, isShutout, firstScorer, firstPlayType, secondScorer, secondPlayType });
  await DB.updateGame(gameId, { status: 'completed' });
  const {error: rpcErr} = await sb.rpc('score_game', {p_game_id: gameId});
  if (rpcErr) console.error('score_game RPC error:', rpcErr);

  const game = await DB.getGame(gameId);
  const msg = isShutout
    ? `ü•Ö Shutout! No first goal in vs ${game?.opponent}. Results posted!`
    : `üö® First goal: ${firstScorer} (${playTypeShort(firstPlayType)}) in vs ${game?.opponent}. Check your score!`;
  await DB.broadcastNotif(S.league.id, msg, 'result_posted');

  toast('Result saved & picks scored!', 'ok');
  closeModal();
  setAdminTab('results');
}

// --- Admin: Players (Roster) ---
async function renderAdminPlayers(league) {
  const [players, ineligible] = await Promise.all([
    DB.getPlayers(league.id),
    DB.getIneligible(league.id),
  ]);
  const ineligSet = new Set(ineligible.map(i => i.playerName));

  return `
  <div>
    <div class="flex items-center justify-between mb-12">
      <div class="text-md">Team Roster</div>
      <button class="btn btn-primary btn-sm" onclick="openAddPlayerModal('${league.id}')">
        ${ico('plus')} Add Player
      </button>
    </div>

    <div class="text-xs text-muted mb-8">Players marked <span class="inelig-badge">Ineligible</span> cannot be picked as darkhorse.</div>

    ${players.length === 0
      ? '<div class="empty"><div class="empty-icon">üë§</div><div class="empty-title">No players</div></div>'
      : `<div class="card" style="padding:8px">
        ${[...players].sort().map(p => `
        <div class="admin-action-row">
          <div>
            <span class="text-sm">${esc(p)}</span>
            ${ineligSet.has(p) ? ' <span class="inelig-badge">DH Ineligible</span>' : ''}
          </div>
          <div class="flex gap-4">
            <button class="btn btn-ghost btn-sm" onclick="toggleIneligible('${league.id}','${esc(p)}')" title="${ineligSet.has(p)?'Remove ineligible':'Mark darkhorse ineligible'}">
              ${ineligSet.has(p) ? '<span style="color:var(--ok)">‚úì Eligible</span>' : '<span style="color:var(--warn)">Mark Ineligible</span>'}
            </button>
            <button class="btn btn-ghost btn-sm" onclick="removePlayer('${league.id}','${esc(p)}')" style="color:var(--err)">${ico('trash')}</button>
          </div>
        </div>`).join('')}
      </div>`}

    ${ineligible.length > 0 ? `
    <div class="section-label">Darkhorse Ineligible Players</div>
    <div class="card">
      ${ineligible.map(i => `
      <div class="admin-action-row">
        <div>
          <div class="text-sm">${esc(i.playerName)}</div>
          ${i.note ? `<div class="text-xs text-muted">${esc(i.note)}</div>` : ''}
          <div class="text-xs text-dim">Added ${fmtDate(i.addedAt)}</div>
        </div>
        <button class="btn btn-ghost btn-sm" onclick="toggleIneligible('${league.id}','${esc(i.playerName)}')" style="color:var(--ok)">Remove</button>
      </div>`).join('')}
    </div>` : ''}
  </div>`;
}

function openAddPlayerModal(leagueId) {
  openModal(`
  <form onsubmit="handleAddPlayer(event,'${leagueId}')">
    <div class="form-group">
      <label class="form-label">Player Name</label>
      <input class="form-input" id="new-player" placeholder="First Last" required>
    </div>
    <button type="submit" class="btn btn-primary btn-block">Add to Roster</button>
  </form>`, 'Add Player');
}

async function handleAddPlayer(e, leagueId) {
  e.preventDefault();
  const btn = e.target.querySelector('[type=submit]');
  btn.disabled = true; btn.textContent = 'Adding‚Ä¶';
  const name = document.getElementById('new-player').value.trim();
  if (!name) { btn.disabled = false; btn.textContent = 'Add to Roster'; return; }
  const players = await DB.getPlayers(leagueId);
  if (players.includes(name)) { toast('Player already on roster', 'err'); btn.disabled = false; btn.textContent = 'Add to Roster'; return; }
  await DB.addPlayer(leagueId, name);
  toast(`${name} added to roster`, 'ok');
  closeModal();
  setAdminTab('players');
}

async function removePlayer(leagueId, name) {
  if (!confirm(`Remove ${name} from roster?`)) return;
  await DB.removePlayer(leagueId, name);
  toast('Player removed', 'ok');
  setAdminTab('players');
}

async function toggleIneligible(leagueId, player) {
  const list = await DB.getIneligible(leagueId);
  if (list.find(i => i.playerName === player)) {
    await DB.removeIneligible(leagueId, player);
    await DB.broadcastNotif(leagueId, `üìã ${player} is now eligible as a darkhorse pick.`, 'system');
    toast(`${player} is now DH-eligible`, 'ok');
    setAdminTab('players');
  } else {
    openModal(`
    <div class="text-sm mb-12">Mark <strong>${esc(player)}</strong> as darkhorse-ineligible?</div>
    <div class="form-group">
      <label class="form-label">Reason / Note (optional)</label>
      <input class="form-input" id="inelig-note" placeholder="e.g. Top scorer this season">
    </div>
    <button class="btn btn-primary btn-block" onclick="confirmIneligible('${leagueId}','${esc(player)}')">Confirm</button>
    `, `Mark DH Ineligible`);
  }
}

async function confirmIneligible(leagueId, player) {
  const note = document.getElementById('inelig-note')?.value || '';
  await DB.addIneligible(leagueId, player, note);
  await DB.broadcastNotif(leagueId, `üìã Player update: ${player} is now darkhorse-ineligible. ${note}`, 'system');
  toast(`${player} marked DH-ineligible`, 'warn');
  closeModal();
  setAdminTab('players');
}

// --- Admin: Season ---
async function renderAdminSeason(league, season, members) {
  const seasons = await DB.getLeagueSeasons(league.id);
  const team = TEAMS[league.teamId];
  const admins = members.filter(m => m.role === 'admin');

  return `
  <div>
    <div class="text-md mb-8">Season Management</div>
    <div class="text-xs text-muted mb-16">${esc(league.name)} ¬∑ ${team?.name||''}</div>

    ${season ? `
    <div class="card mb-16" style="border-color:var(--ok)">
      <div class="flex items-center justify-between mb-8">
        <div>
          <div class="text-sm fw-bold">${esc(season.name)}</div>
          <div class="text-xs text-muted">Started ${fmtDate(season.startDate)}</div>
        </div>
        <span class="pill pill-ok">Active</span>
      </div>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px">
        <button class="btn btn-secondary btn-sm" onclick="openEditSeasonModal('${season.id}','${esc(season.name)}')">Edit Name</button>
        <button class="btn btn-danger btn-sm" onclick="archiveSeason('${season.id}','${league.id}')">Archive Season</button>
      </div>
    </div>` : `
    <div class="card mb-16" style="border-color:var(--warn)">
      <div class="text-sm mb-8">No active season. Start a new one to allow picks.</div>
      <button class="btn btn-primary" onclick="startNewSeason('${league.id}')">Start New Season</button>
    </div>`}

    <div class="section-label">Admin Team</div>
    <div class="card mb-16">
      ${admins.map(m => `
      <div class="admin-action-row">
        <div class="flex items-center gap-8">
          <div class="avatar avatar-sm">${initials(m.username)}</div>
          <div>
            <div class="text-sm">${esc(m.username)}</div>
            <div class="text-xs text-muted">${esc(m.email)}</div>
          </div>
        </div>
        ${m.userId !== S.user.id ? `<button class="btn btn-ghost btn-sm" onclick="removeAdmin('${league.id}','${m.userId}')" style="color:var(--err)">Remove</button>` : '<span class="pill pill-ok">You</span>'}
      </div>`).join('')}
      <div class="mt-8">
        <button class="btn btn-secondary btn-sm" onclick="openAddAdminModal('${league.id}')">
          ${ico('plus')} Add Admin
        </button>
      </div>
    </div>

    <div class="section-label">League Members (${members.length})</div>
    <div class="card">
      ${members.map(m => `
      <div class="admin-action-row">
        <div class="flex items-center gap-8">
          <div class="avatar avatar-sm">${initials(m.username)}</div>
          <div>
            <div class="text-sm">${esc(m.username)}</div>
            <div class="text-xs text-muted">${m.role}</div>
          </div>
        </div>
        ${m.role !== 'admin' ? `<button class="btn btn-ghost btn-sm" onclick="makeAdmin('${league.id}','${m.userId}')">Make Admin</button>` : ''}
      </div>`).join('')}
    </div>

    ${seasons.filter(s => s.status === 'archived').length > 0 ? `
    <div class="section-label">Past Seasons</div>
    ${seasons.filter(s => s.status === 'archived').map(s => `
    <div class="card card-sm mb-8">
      <div class="flex items-center justify-between">
        <div>
          <div class="text-sm">${esc(s.name)}</div>
          <div class="text-xs text-muted">Archived ${fmtDate(s.endDate)}</div>
        </div>
        <span class="pill pill-gray">Archived</span>
      </div>
    </div>`).join('')}` : ''}
  </div>`;
}

function startNewSeason(leagueId) {
  openModal(`
  <form onsubmit="handleStartSeason(event,'${leagueId}')">
    <div class="form-group">
      <label class="form-label">Season Name</label>
      <input class="form-input" id="new-season-name" placeholder="e.g. 2025-26 Season" required>
    </div>
    <button type="submit" class="btn btn-primary btn-block">Start Season</button>
  </form>`, 'New Season');
}

async function handleStartSeason(e, leagueId) {
  e.preventDefault();
  const btn = e.target.querySelector('[type=submit]');
  btn.disabled = true; btn.textContent = 'Starting‚Ä¶';
  const name = document.getElementById('new-season-name').value.trim();
  if (!name) { btn.disabled = false; btn.textContent = 'Start Season'; return; }
  await DB.createSeason({leagueId, name, status: 'active', startDate: new Date().toISOString()});
  await DB.broadcastNotif(leagueId, `üèí New season started: ${name}. Good luck!`, 'system');
  toast('Season started!', 'ok');
  closeModal();
  setAdminTab('season');
}

async function archiveSeason(seasonId, leagueId) {
  if (!confirm('Archive this season? This will end pick submissions for all current games.')) return;
  await DB.updateSeason(seasonId, {status: 'archived', endDate: new Date().toISOString()});
  await DB.broadcastNotif(leagueId, 'üì¶ Season has been archived. Thanks for playing!', 'system');
  toast('Season archived', 'ok');
  setAdminTab('season');
}

function openEditSeasonModal(seasonId, currentName) {
  openModal(`
  <form onsubmit="handleEditSeason(event,'${seasonId}')">
    <div class="form-group">
      <label class="form-label">Season Name</label>
      <input class="form-input" id="edit-season-name" value="${esc(currentName||'')}" required>
    </div>
    <button type="submit" class="btn btn-primary btn-block">Save</button>
  </form>`, 'Edit Season');
}

async function handleEditSeason(e, seasonId) {
  e.preventDefault();
  const btn = e.target.querySelector('[type=submit]');
  btn.disabled = true; btn.textContent = 'Saving‚Ä¶';
  const name = document.getElementById('edit-season-name').value.trim();
  await DB.updateSeason(seasonId, {name});
  toast('Season updated', 'ok');
  closeModal();
  setAdminTab('season');
}

function openAddAdminModal(leagueId) {
  openModal(`
  <form onsubmit="handleAddAdmin(event,'${leagueId}')">
    <div class="form-group">
      <label class="form-label">Username or Email</label>
      <input class="form-input" id="add-admin-query" placeholder="Enter username or email">
    </div>
    <div id="add-admin-err" class="form-error mb-8"></div>
    <button type="submit" class="btn btn-primary btn-block">Add as Admin</button>
  </form>`, 'Add Admin');
}

async function handleAddAdmin(e, leagueId) {
  e.preventDefault();
  const q = document.getElementById('add-admin-query').value.trim();
  const {data: found} = await sb.from('profiles')
    .select('id, username, email')
    .or(`username.ilike.${q},email.ilike.${q}`)
    .limit(1);
  if (!found || found.length === 0) { document.getElementById('add-admin-err').textContent = 'User not found'; return; }
  const u = toCamel(found[0]);
  const members = await DB.getLeagueMembers(leagueId);
  const existing = members.find(m => m.userId === u.id);
  if (existing) {
    if (existing.role === 'admin') { document.getElementById('add-admin-err').textContent = 'Already an admin'; return; }
    await DB.setMemberRole(leagueId, u.id, 'admin');
  } else {
    await DB.addMember(leagueId, u.id, 'admin');
  }
  await DB.broadcastNotif(leagueId, `${u.username} has been added as a league admin.`, 'system');
  toast(`${u.username} is now an admin`, 'ok');
  closeModal();
  setAdminTab('season');
}

async function makeAdmin(leagueId, userId) {
  await DB.setMemberRole(leagueId, userId, 'admin');
  toast('Promoted to admin', 'ok');
  setAdminTab('season');
}

async function removeAdmin(leagueId, userId) {
  await DB.setMemberRole(leagueId, userId, 'member');
  toast('Admin removed', 'ok');
  setAdminTab('season');
}

// ==================== GLOBAL EVENT HANDLERS =================
// Close dropdowns on outside click
document.addEventListener('click', e => {
  if (!e.target.closest('.player-search-wrap')) {
    document.querySelectorAll('.player-dropdown').forEach(d => d.classList.add('hidden'));
  }
  if (!e.target.closest('.modal-sheet') && !e.target.closest('[onclick*="Modal"]') &&
      !e.target.closest('[onclick*="modal"]')) {
    // Modal closed by overlay click (handled in openModal)
  }
});

// ==================== REALTIME ==============================
async function subscribeLeague(leagueId) {
  // Remove any existing channels
  for (const ch of S.channels) await sb.removeChannel(ch);
  S.channels = [];
  if (!leagueId) return;

  const ch = sb.channel(`league-${leagueId}`)
    .on('postgres_changes', {
      event: 'INSERT', schema: 'public', table: 'notifications',
      filter: `league_id=eq.${leagueId}`,
    }, payload => {
      if (payload.new?.user_id === S.authUser?.id) {
        S.unread++;
        renderHeader();
      }
    })
    .on('postgres_changes', {
      event: 'INSERT', schema: 'public', table: 'results',
    }, () => {
      if (['picks', 'standings', 'history', 'admin'].includes(S.view)) render();
    })
    .on('postgres_changes', {
      event: '*', schema: 'public', table: 'games',
      filter: `league_id=eq.${leagueId}`,
    }, () => {
      if (['dashboard', 'picks', 'admin'].includes(S.view)) render();
    })
    .subscribe();

  S.channels.push(ch);
}

// ==================== INIT ==================================
function init() {
  // Show login immediately ‚Äî don't wait for Supabase
  route('auth');

  // Then check if there's an existing session in the background
  sb.auth.getSession().then(({ data: { session } }) => {
    if (session && !S.authUser) afterLogin(session.user).catch(console.error);
  }).catch(err => console.error('getSession:', err));

  // Listen for future sign-in / sign-out events
  sb.auth.onAuthStateChange(async (event, session) => {
    try {
      if (event === 'PASSWORD_RECOVERY') {
        // User clicked the reset link in their email ‚Äî show the new-password form
        route('auth');
        setTimeout(() => authShowTab('reset'), 50);
        return;
      }
      if (event === 'SIGNED_IN' && session && !S.authUser) {
        await afterLogin(session.user);
      } else if (event === 'SIGNED_OUT') {
        S.user = null; S.authUser = null; S.league = null;
        S.userLeagues = []; S.isAdmin = false; S.unread = 0;
        for (const ch of S.channels) await sb.removeChannel(ch);
        S.channels = [];
        S.timers.forEach(clearTimeout); S.timers = [];
        route('auth');
      }
    } catch(err) {
      console.error('onAuthStateChange error:', err);
      toast('Something went wrong. Please refresh.', 'err');
    }
  });
}

init();
</script>
</body>
</html>

